<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>reportes.backend.dll_copy &mdash; Dama_project 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> Dama_project
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Dama_project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">reportes.backend.dll_copy</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for reportes.backend.dll_copy</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">reportes.security.update_google_sheet</span> <span class="kn">import</span> <span class="n">my_worksheet</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">unidecode</span> <span class="kn">import</span> <span class="n">unidecode</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="c1"># get close matches</span>
<span class="kn">from</span> <span class="nn">difflib</span> <span class="kn">import</span> <span class="n">get_close_matches</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">re</span>

<div class="viewcode-block" id="ExcelPreprocessMain"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelPreprocessMain">[docs]</a><span class="k">class</span> <span class="nc">ExcelPreprocessMain</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_gen</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path_gen</span>
  <span class="c1"># LOAD:</span>
<div class="viewcode-block" id="ExcelPreprocessMain.load"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelPreprocessMain.load">[docs]</a>  <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>
  <span class="c1"># WRITES:</span>
<div class="viewcode-block" id="ExcelPreprocessMain.write"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelPreprocessMain.write">[docs]</a>  <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ind</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span></div>
  <span class="c1"># WRITES ENGINE:</span>
<div class="viewcode-block" id="ExcelPreprocessMain.write_engine"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelPreprocessMain.write_engine">[docs]</a>  <span class="k">def</span> <span class="nf">write_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_dfs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ind</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;xlsxwriter&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tpl_df</span> <span class="ow">in</span> <span class="n">list_dfs</span><span class="p">:</span>
      <span class="n">df</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tpl_df</span>
      <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>
  <span class="c1"># WRITES GOOGLE SHEET:</span>
<div class="viewcode-block" id="ExcelPreprocessMain.write_google_sheet"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelPreprocessMain.write_google_sheet">[docs]</a>  <span class="k">def</span> <span class="nf">write_google_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">rol</span><span class="p">,</span> <span class="n">documento</span><span class="p">,</span> <span class="n">hoja</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">work_s</span> <span class="o">=</span> <span class="n">my_worksheet</span><span class="p">(</span><span class="n">rol</span><span class="p">,</span> <span class="n">documento</span><span class="p">,</span> <span class="n">hoja</span><span class="p">)</span>
      <span class="n">work_s</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
      <span class="n">work_s</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">value_input_option</span><span class="o">=</span><span class="s1">&#39;USER_ENTERED&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">filas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
      <span class="n">columnas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
      <span class="n">work_s</span> <span class="o">=</span> <span class="n">my_worksheet</span><span class="p">(</span><span class="n">rol</span><span class="p">,</span> <span class="n">documento</span><span class="p">,</span> <span class="n">hoja</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="n">filas</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">columnas</span><span class="p">)</span>
      <span class="n">work_s</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
      <span class="n">work_s</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">value_input_option</span><span class="o">=</span><span class="s1">&#39;USER_ENTERED&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="ExcelPreprocessMain.get_google_sheet"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelPreprocessMain.get_google_sheet">[docs]</a>  <span class="k">def</span> <span class="nf">get_google_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rol</span><span class="p">,</span><span class="n">documento</span><span class="p">,</span><span class="n">hoja</span><span class="p">):</span>
    <span class="n">work_s</span> <span class="o">=</span> <span class="n">my_worksheet</span><span class="p">(</span><span class="n">rol</span><span class="p">,</span> <span class="n">documento</span><span class="p">,</span> <span class="n">hoja</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">work_s</span><span class="o">.</span><span class="n">get_all_records</span><span class="p">(</span><span class="n">numericise_ignore</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">df</span></div></div>
  
<div class="viewcode-block" id="ExcelServicios"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelServicios">[docs]</a><span class="k">class</span> <span class="nc">ExcelServicios</span><span class="p">(</span><span class="n">ExcelPreprocessMain</span><span class="p">):</span>
<div class="viewcode-block" id="ExcelServicios.make_service2pss"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelServicios.make_service2pss">[docs]</a>  <span class="k">def</span> <span class="nf">make_service2pss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_pss</span><span class="p">,</span> <span class="n">name_load</span><span class="p">,</span> <span class="n">name_pss2</span><span class="p">,</span> <span class="n">name_save</span><span class="p">,</span> <span class="n">df_historico</span><span class="p">,</span> <span class="n">df_psl</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Cargar siapss:</span>
    <span class="n">df_siaspp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name_pss</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Cargar unal_lee subido principal (excepcional con el caso de PSL act voluntarias):</span>
    <span class="k">if</span> <span class="n">df_psl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">df_ppl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name_load</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">df_ppl</span> <span class="o">=</span> <span class="n">df_psl</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">df_ppl</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
    <span class="c1"># Convert fecha a datetime y errores volver NaT:</span>
    <span class="n">df_ppl</span><span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_ppl</span><span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
    <span class="c1"># Rellenar datos perdidos en fecha (para arriba, para abajo):</span>
    <span class="n">df_ppl</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_ppl</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>
    <span class="n">df_ppl</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_ppl</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;bfill&#39;</span><span class="p">)</span>
    <span class="c1"># ============== hacer lo mismo de fecha pero para historico:</span>
    <span class="c1"># Nota: El historico viene VARCHAR -&gt; hacer esto es importante</span>
    <span class="c1"># y esta bien.</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c1"># Convert fecha a datetime y errores volver NaT:</span>
      <span class="n">df_historico</span><span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_historico</span><span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
      <span class="c1"># Rellenar datos perdidos en fecha (para arriba, para abajo):</span>
      <span class="n">df_historico</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_historico</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>
      <span class="n">df_historico</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_historico</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;bfill&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">pass</span>
    <span class="c1"># Convertir documento a texto:</span>
    <span class="n">df_ppl</span><span class="p">[</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl</span><span class="p">[</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.0&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># ====================================================</span>
    <span class="c1"># Encuentro los programas parecidos con los nombres oficiales:</span>
    <span class="n">df_ppl</span><span class="p">[</span><span class="s1">&#39;PROGRAMA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl</span><span class="p">[</span><span class="s1">&#39;PROGRAMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">df_ppl</span><span class="p">[</span><span class="s1">&#39;PROGRAMA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl</span><span class="p">[</span><span class="s1">&#39;PROGRAMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">encontrar_mas_cercano</span><span class="p">,</span> <span class="n">case_match</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Quitar informacion redudante con el SIA:</span>
    <span class="n">df_ppl_2</span> <span class="o">=</span> <span class="n">df_ppl</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NOMBRES Y APELLIDOS&#39;</span><span class="p">,</span><span class="s1">&#39;PROGRAMA&#39;</span><span class="p">,</span><span class="s1">&#39;CORREO&#39;</span><span class="p">])</span>
    <span class="c1"># Juntar df actual con siaspp:</span>
    <span class="n">df_ppl_3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_ppl_2</span><span class="p">,</span> <span class="n">df_siaspp</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">)</span>
    <span class="c1"># Copia del df merged:</span>
    <span class="n">df_ppl_3_copy</span> <span class="o">=</span> <span class="n">df_ppl_3</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># De PLAN == NULL en SIA tomar indices y remplazar por los &quot;PROGRAMA&quot;</span>
    <span class="c1"># previamente &quot;matcheados&quot;</span>
    <span class="n">index_nan_PLAN</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="n">df_ppl_3</span><span class="p">[</span><span class="s1">&#39;PLAN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span>
    <span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_nan_PLAN</span> <span class="p">,</span><span class="s1">&#39;PLAN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl</span><span class="p">[</span><span class="s1">&#39;PROGRAMA&#39;</span><span class="p">]</span>
    <span class="c1"># Si la hoja de datos tiene la columna &quot;MI-FACULTAD&quot;...</span>
    <span class="k">if</span> <span class="s1">&#39;MI-FACULTAD&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
      <span class="c1"># Idenfificar indices de FACULDAD (SIA) nulos y &quot;&quot;:</span>
      <span class="n">index_nan_FACULTAD</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span> <span class="p">(</span><span class="n">df_ppl_3</span><span class="p">[</span><span class="s1">&#39;FACULTAD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">|</span> <span class="p">(</span><span class="n">df_ppl_3</span><span class="p">[</span><span class="s1">&#39;FACULTAD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>
      <span class="c1"># Preparar &quot;MI-FACULTAD&quot; poniendolo en UPPER y encontrandole matches oficiales:</span>
      <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="s1">&#39;MI-FACULTAD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="s1">&#39;MI-FACULTAD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
      <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="s1">&#39;MI-FACULTAD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="s1">&#39;MI-FACULTAD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">encontrar_mas_cercano</span><span class="p">,</span> <span class="n">case_match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="c1"># En los index NaN o &quot;&quot; de FACULTAD poner los correspondientes &quot;MI-FACULTAD&quot;</span>
      <span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_nan_FACULTAD</span> <span class="p">,</span><span class="s1">&#39;FACULTAD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="s1">&#39;MI-FACULTAD&#39;</span><span class="p">]</span>
      <span class="c1"># Volver a hacer el proceso pero esta vez con los datos de facultad no matcheados:</span>
      <span class="c1"># rellenar con los valores de PROGRAMA:</span>
      <span class="n">index_nan_FACULTAD</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="s1">&#39;FACULTAD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="s1">&#39;FACULTAD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>
      <span class="n">values_PLAN</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_nan_FACULTAD</span><span class="p">,</span> <span class="s1">&#39;PLAN&#39;</span><span class="p">]</span>
      <span class="c1"># Tomar todos los valores df_ppl_3_copy y añadir &quot;FAC&quot;</span>
      <span class="n">merged_data</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_nueva</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;PLAN&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;NOMID1&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
      <span class="c1"># De merged_data con los indices nan o &quot;&quot; tomar &#39;FAC&#39;</span>
      <span class="n">values_A</span> <span class="o">=</span> <span class="n">merged_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_nan_FACULTAD</span><span class="p">,</span> <span class="s1">&#39;FAC&#39;</span><span class="p">]</span>
      <span class="c1"># Reemplazarlo en su ubicacion correspondiente:</span>
      <span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_nan_FACULTAD</span><span class="p">,</span> <span class="s1">&#39;FACULTAD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values_A</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Hacer lo mismo que se hizo anteriormente pero sin el proceso de &quot;MI-FACULTAD&quot;</span>
      <span class="n">index_nan_FACULTAD</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="n">df_ppl_3</span><span class="p">[</span><span class="s1">&#39;FACULTAD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">df_ppl_3</span><span class="p">[</span><span class="s1">&#39;FACULTAD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>
      <span class="n">values_PLAN</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_nan_FACULTAD</span><span class="p">,</span> <span class="s1">&#39;PLAN&#39;</span><span class="p">]</span>
      <span class="c1"># df_nueva = df_planes[[&#39;FACULTAD&#39;, &#39;NOMID1&#39;]].copy()</span>
      <span class="n">merged_data</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_nueva</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;PLAN&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;NOMID1&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
      <span class="n">values_A</span> <span class="o">=</span> <span class="n">merged_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_nan_FACULTAD</span><span class="p">,</span> <span class="s1">&#39;FAC&#39;</span><span class="p">]</span>
      <span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_nan_FACULTAD</span><span class="p">,</span> <span class="s1">&#39;FACULTAD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values_A</span>
    <span class="c1"># volver a cargar DPSS</span>
    <span class="n">df_pss2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name_pss2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># cargo programa de gov.</span>
    <span class="c1"># Convertir documento a texto:</span>
    <span class="n">df_pss2</span><span class="p">[</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pss2</span><span class="p">[</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.0&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Obtengo documento de filas donde cohorte es nulo:</span>
    <span class="n">df_ppl_5</span> <span class="o">=</span> <span class="n">df_ppl_3</span><span class="p">[</span><span class="n">df_ppl_3</span><span class="p">[</span><span class="s1">&#39;COHORTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">]</span>
    <span class="c1"># Busco todas las filas de df_pss2 donde cohorte es nulo:</span>
    <span class="n">df_pss2_R</span> <span class="o">=</span> <span class="n">df_pss2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pss2</span><span class="p">[</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df_ppl_5</span><span class="p">))]</span>
    <span class="c1"># Tomo cedulas de filas nulas:</span>
    <span class="n">Ced_gov_null</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_pss2_R</span><span class="p">[</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">])</span>
    <span class="c1"># Por cada una pongo en COHORTE el valor de dpss</span>
    <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">Ced_gov_null</span><span class="p">:</span>
      <span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">DOCUMENTO</span> <span class="o">==</span> <span class="n">cc</span><span class="p">,</span> <span class="s1">&#39;COHORTE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_pss2_R</span><span class="p">[</span><span class="n">df_pss2_R</span><span class="o">.</span><span class="n">DOCUMENTO</span> <span class="o">==</span> <span class="n">cc</span><span class="p">][</span><span class="s1">&#39;COHORTE&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># En los que definitivamente no se encontro, se busca y se pone Estudiante Regular:</span>
    <span class="n">index_nan_CO</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="s1">&#39;COHORTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="p">]</span><span class="o">.</span><span class="n">index</span>
    <span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_nan_CO</span> <span class="p">,</span><span class="s1">&#39;COHORTE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Estudiante Regular&#39;</span>
    <span class="c1"># Convertir a texto Cedula-Ri:</span>
    <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="s1">&#39;CEDULA-RI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="s1">&#39;CEDULA-RI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.0&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Rellenar todos los valores con valores vacios:</span>
    <span class="n">df_ppl_3_copy</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># Quitar tildes y espacios:</span>
    <span class="n">columnas</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columnas</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PROM_ACADEMICO_ACTUAL&#39;</span><span class="p">,</span><span class="s1">&#39;PAPA_PERIODO&#39;</span><span class="p">,</span><span class="s1">&#39;AVANCE_CARRERA&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">unidecode</span><span class="p">)</span>
          <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
          <span class="k">pass</span>
      <span class="c1"># ============ MODIFICACION PARA PASAR TODA LA COL</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
          <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
          <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">df_historico</span><span class="o">.</span><span class="n">FECHA</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_historico</span><span class="o">.</span><span class="n">FECHA</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">pass</span>
    <span class="c1"># Concatenar historico con actual:</span>

    <span class="c1">#==================== NUEVO PARA SOPESAR QUE CUANDO SI HAY HISTORICO</span>
    <span class="c1"># =================== PUEDE QUE HAYAN NOMBRES DE COLS REPETIDAS:</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">cols_tupl</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
    <span class="n">cols_tupl</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_tupl</span><span class="p">]</span>
    <span class="n">cols_tupl</span> <span class="o">=</span> <span class="p">[</span><span class="n">unidecode</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_tupl</span><span class="p">]</span>
    <span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">cols_tupl</span>

    <span class="c1"># =============================================================</span>

    <span class="n">df_concat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_historico</span><span class="p">,</span> <span class="n">df_ppl_3_copy</span><span class="p">])</span>
    <span class="c1"># Ordenar la df en funcion de la fecha:</span>
    <span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;FECHA&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">df_concat</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;FECHA&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Convertirla a string:</span>
    <span class="n">df_concat</span><span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_concat</span><span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y&quot;</span><span class="p">)</span>
    <span class="c1"># Rellenar todos los valores con valores vacios:</span>
    <span class="n">df_concat</span> <span class="o">=</span> <span class="n">df_concat</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># Capitalizar todo el texto:</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_ppl_3_copy</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>  <span class="c1"># Verificar si la columna contiene texto</span>
          <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl_3_copy</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">capitalize_text</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_concat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">df_concat</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>  <span class="c1"># Verificar si la columna contiene texto</span>
          <span class="n">df_concat</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_concat</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">capitalize_text</span><span class="p">)</span>
    <span class="c1"># Escribo documento excel:</span>
    <span class="n">list_dfs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">df_ppl_3_copy</span><span class="p">,</span> <span class="s1">&#39;PRINCIPAL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">df_concat</span><span class="p">,</span> <span class="s1">&#39;HISTORICO&#39;</span><span class="p">)</span>
              <span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_engine</span><span class="p">(</span><span class="n">list_dfs</span><span class="p">,</span> <span class="n">name_save</span><span class="p">)</span>
    <span class="c1"># Devuelvo info actual + historica:</span>
    <span class="c1"># ::::::::::::::::::::::::::::</span>
    <span class="n">df_ppl_3_copy</span> <span class="o">=</span> <span class="n">fill_empty_spaces</span><span class="p">(</span><span class="n">df_ppl_3_copy</span><span class="p">)</span>
    <span class="n">df_concat</span> <span class="o">=</span> <span class="n">fill_empty_spaces</span><span class="p">(</span><span class="n">df_concat</span><span class="p">)</span>  
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;====== ANTES DE ESCRIBIR ===================&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
       <span class="n">df_concat</span><span class="p">[</span><span class="s2">&quot;PERIODO_AT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_concat</span><span class="p">[</span><span class="s2">&quot;PERIODO_AT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
       <span class="k">pass</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df_concat</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>                          
    <span class="k">return</span> <span class="n">df_ppl_3_copy</span><span class="p">,</span> <span class="n">df_concat</span></div>


<div class="viewcode-block" id="ExcelServicios.make_serviceUTP"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelServicios.make_serviceUTP">[docs]</a>  <span class="k">def</span> <span class="nf">make_serviceUTP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_pss</span><span class="p">,</span> <span class="n">name_load</span><span class="p">,</span> <span class="n">name_pss2</span><span class="p">,</span> <span class="n">name_save</span><span class="p">,</span> <span class="n">df_historico</span><span class="p">):</span>
    <span class="c1"># Cargar siapss:</span>
    <span class="c1">#df_siaspp = self.load(name_pss, 0, 0)</span>
    <span class="c1"># Cargar unal_lee subido principal:</span>
    <span class="n">df_ppl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name_load</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Convert fecha a datetime y errores volver NaT:</span>
    <span class="n">df_ppl</span><span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_ppl</span><span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
    <span class="c1"># Rellenar datos perdidos en fecha (para arriba, para abajo):</span>
    <span class="n">df_ppl</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_ppl</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>
    <span class="n">df_ppl</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_ppl</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;bfill&#39;</span><span class="p">)</span>
    <span class="c1"># ============== hacer lo mismo de fecha pero para historico:</span>
    <span class="c1"># Nota: El historico viene VARCHAR -&gt; hacer esto es importante</span>
    <span class="c1"># y esta bien.</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c1"># Convert fecha a datetime y errores volver NaT:</span>
      <span class="n">df_historico</span><span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_historico</span><span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
      <span class="c1"># Rellenar datos perdidos en fecha (para arriba, para abajo):</span>
      <span class="n">df_historico</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_historico</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>
      <span class="n">df_historico</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_historico</span><span class="p">[[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;bfill&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">pass</span>
    <span class="c1"># Convertir documento a texto:</span>
    <span class="c1">#df_ppl[&#39;DOCUMENTO&#39;] = df_ppl[&#39;DOCUMENTO&#39;].fillna(&#39;&#39;).astype(str).str.replace(&quot;.0&quot;,&quot;&quot;,regex=False)</span>
    <span class="c1"># ====================================================</span>
    <span class="c1"># Encuentro los programas parecidos con los nombres oficiales:</span>
    <span class="n">df_ppl</span><span class="p">[</span><span class="s1">&#39;PROGRAMA DEPARTAMENTO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl</span><span class="p">[</span><span class="s1">&#39;PROGRAMA DEPARTAMENTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">df_ppl</span><span class="p">[</span><span class="s1">&#39;PROGRAMA DEPARTAMENTO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl</span><span class="p">[</span><span class="s1">&#39;PROGRAMA DEPARTAMENTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">encontrar_mas_cercano</span><span class="p">,</span> <span class="n">case_match</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Quitar informacion redudante con el SIA:</span>
    <span class="c1">#df_ppl_2 = df_ppl.drop(columns=[&#39;NOMBRES Y APELLIDOS&#39;,&#39;PROGRAMA&#39;,&#39;CORREO&#39;])</span>
    <span class="c1"># Juntar df actual con siaspp:</span>
    <span class="c1">#df_ppl_3 = pd.merge(df_ppl_2, df_siaspp, how = &#39;left&#39;, on=&#39;DOCUMENTO&#39;)</span>
    <span class="c1"># Copia del df merged:</span>
    <span class="c1">#df_ppl_3_copy = df_ppl_3.copy()</span>
    <span class="c1"># De PLAN == NULL en SIA tomar indices y remplazar por los &quot;PROGRAMA&quot;</span>
    <span class="c1"># previamente &quot;matcheados&quot;</span>
    <span class="c1">#index_nan_PLAN = df_ppl_3_copy[df_ppl_3[&#39;PLAN&#39;].isnull()].index</span>
    <span class="c1">#df_ppl_3_copy.loc[index_nan_PLAN ,&#39;PLAN&#39;] = df_ppl[&#39;PROGRAMA&#39;]</span>
    <span class="c1"># Si la hoja de datos tiene la columna &quot;MI-FACULTAD&quot;...</span>
    <span class="c1">#if &#39;MI-FACULTAD&#39; in list(df_ppl_3_copy.columns):</span>
      <span class="c1"># Idenfificar indices de FACULDAD (SIA) nulos y &quot;&quot;:</span>
    <span class="c1">#  index_nan_FACULTAD = df_ppl_3_copy[ (df_ppl_3[&#39;FACULTAD&#39;].isnull()) | (df_ppl_3[&#39;FACULTAD&#39;] == &#39;&#39;)].index</span>
      <span class="c1"># Preparar &quot;MI-FACULTAD&quot; poniendolo en UPPER y encontrandole matches oficiales:</span>
    <span class="c1">#  df_ppl_3_copy[&#39;MI-FACULTAD&#39;] = df_ppl_3_copy[&#39;MI-FACULTAD&#39;].str.upper()</span>
    <span class="c1">#  df_ppl_3_copy[&#39;MI-FACULTAD&#39;] = df_ppl_3_copy[&#39;MI-FACULTAD&#39;].apply(encontrar_mas_cercano, case_match = 1)</span>
      <span class="c1"># En los index NaN o &quot;&quot; de FACULTAD poner los correspondientes &quot;MI-FACULTAD&quot;</span>
    <span class="c1">#  df_ppl_3_copy.loc[index_nan_FACULTAD ,&#39;FACULTAD&#39;] = df_ppl_3_copy[&#39;MI-FACULTAD&#39;]</span>
      <span class="c1"># Volver a hacer el proceso pero esta vez con los datos de facultad no matcheados:</span>
      <span class="c1"># rellenar con los valores de PROGRAMA:</span>
    <span class="c1">#  index_nan_FACULTAD = df_ppl_3_copy[df_ppl_3_copy[&#39;FACULTAD&#39;].isnull() | (df_ppl_3_copy[&#39;FACULTAD&#39;] == &#39;&#39;)].index</span>
    <span class="c1">#  values_PLAN = df_ppl_3_copy.loc[index_nan_FACULTAD, &#39;PLAN&#39;]</span>
      <span class="c1"># Tomar todos los valores df_ppl_3_copy y añadir &quot;FAC&quot;</span>
    <span class="c1">#  merged_data = df_ppl_3_copy.merge(df_nueva, left_on=&#39;PLAN&#39;, right_on=&#39;NOMID1&#39;, how=&#39;left&#39;)</span>
      <span class="c1"># De merged_data con los indices nan o &quot;&quot; tomar &#39;FAC&#39;</span>
    <span class="c1">#  values_A = merged_data.loc[index_nan_FACULTAD, &#39;FAC&#39;]</span>
      <span class="c1"># Reemplazarlo en su ubicacion correspondiente:</span>
    <span class="c1"># df_ppl_3_copy.loc[index_nan_FACULTAD, &#39;FACULTAD&#39;] = values_A</span>
    <span class="c1">#else:</span>
      <span class="c1"># Hacer lo mismo que se hizo anteriormente pero sin el proceso de &quot;MI-FACULTAD&quot;</span>
    <span class="c1">#  index_nan_FACULTAD = df_ppl_3_copy[df_ppl_3[&#39;FACULTAD&#39;].isnull() | (df_ppl_3[&#39;FACULTAD&#39;] == &#39;&#39;)].index</span>
    <span class="c1">#  values_PLAN = df_ppl_3_copy.loc[index_nan_FACULTAD, &#39;PLAN&#39;]</span>
      <span class="c1"># df_nueva = df_planes[[&#39;FACULTAD&#39;, &#39;NOMID1&#39;]].copy()</span>
    <span class="c1">#  merged_data = df_ppl_3_copy.merge(df_nueva, left_on=&#39;PLAN&#39;, right_on=&#39;NOMID1&#39;, how=&#39;left&#39;)</span>
    <span class="c1">#  values_A = merged_data.loc[index_nan_FACULTAD, &#39;FAC&#39;]</span>
    <span class="c1">#  df_ppl_3_copy.loc[index_nan_FACULTAD, &#39;FACULTAD&#39;] = values_A</span>
    <span class="c1"># volver a cargar DPSS</span>
    <span class="c1">#df_pss2 = self.load(name_pss2, 0, 0) # cargo programa de gov.</span>
    <span class="c1"># Convertir documento a texto:</span>
    <span class="c1">#df_pss2[&#39;DOCUMENTO&#39;] = df_pss2[&#39;DOCUMENTO&#39;].fillna(&#39;&#39;).astype(str).str.replace(&quot;.0&quot;,&quot;&quot;,regex=False)</span>
    <span class="c1"># Obtengo documento de filas donde cohorte es nulo:</span>
    <span class="c1">#df_ppl_5 = df_ppl_3[df_ppl_3[&#39;COHORTE&#39;].isnull()][&#39;DOCUMENTO&#39;]</span>
    <span class="c1"># Busco todas las filas de df_pss2 donde cohorte es nulo:</span>
    <span class="c1">#df_pss2_R = df_pss2.loc[df_pss2[&#39;DOCUMENTO&#39;].isin(list(df_ppl_5))]</span>
    <span class="c1"># Tomo cedulas de filas nulas:</span>
    <span class="c1">#Ced_gov_null = list(df_pss2_R[&#39;DOCUMENTO&#39;])</span>
    <span class="c1"># Por cada una pongo en COHORTE el valor de dpss</span>
    <span class="c1">#for cc in Ced_gov_null:</span>
    <span class="c1">#  df_ppl_3_copy.loc[df_ppl_3_copy.DOCUMENTO == cc, &#39;COHORTE&#39;] = list(df_pss2_R[df_pss2_R.DOCUMENTO == cc][&#39;COHORTE&#39;])[0]</span>
    <span class="c1"># En los que definitivamente no se encontro, se busca y se pone Estudiante Regular:</span>
    <span class="c1">#index_nan_CO = df_ppl_3_copy[ df_ppl_3_copy[&#39;COHORTE&#39;].isnull() ].index</span>
    <span class="c1">#df_ppl_3_copy.loc[index_nan_CO ,&#39;COHORTE&#39;] = &#39;Estudiante Regular&#39;</span>
    <span class="c1"># Convertir a texto Cedula-Ri:</span>
    <span class="c1">#df_ppl_3_copy[&#39;CEDULA-RI&#39;] = df_ppl_3_copy[&#39;CEDULA-RI&#39;].fillna(&#39;&#39;).astype(str).str.replace(&quot;.0&quot;,&quot;&quot;,regex=False)</span>
    <span class="c1"># Rellenar todos los valores con valores vacios:</span>
    <span class="c1">#df_ppl_3_copy = df_ppl_3_copy.fillna(value=&#39;&#39;)</span>
    <span class="c1"># Quitar tildes y espacios:</span>
    <span class="c1">#columnas = list(df_ppl_3_copy.columns)</span>
    <span class="c1">#for col in columnas:</span>
    <span class="c1">#  if col not in [&#39;PROM_ACADEMICO_ACTUAL&#39;,&#39;PAPA_PERIODO&#39;,&#39;AVANCE_CARRERA&#39;]:</span>
    <span class="c1">#    try:</span>
    <span class="c1">#      df_ppl_3_copy[col] = df_ppl_3_copy[col].apply(unidecode)</span>
    <span class="c1">#      df_ppl_3_copy[col] = df_ppl_3_copy[col].str.strip()</span>
    <span class="c1">#    except:</span>
    <span class="c1">#      pass</span>
      <span class="c1"># ============ MODIFICACION PARA PASAR TODA LA COL</span>
    <span class="c1">#  else:</span>
    <span class="c1">#    try:</span>
    <span class="c1">#      df_ppl_3_copy[col] = df_ppl_3_copy[col].astype(str)</span>
    <span class="c1">#      df_ppl_3_copy[col] = df_ppl_3_copy[col].str.replace(&quot;.&quot;,&quot;,&quot;)</span>
    <span class="c1">#    except:</span>
    <span class="c1">#      pass</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">df_historico</span><span class="o">.</span><span class="n">FECHA</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_historico</span><span class="o">.</span><span class="n">FECHA</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">pass</span>
    <span class="c1"># Concatenar historico con actual:</span>

    <span class="c1">#==================== NUEVO PARA SOPESAR QUE CUANDO SI HAY HISTORICO</span>
    <span class="c1"># =================== PUEDE QUE HAYAN NOMBRES DE COLS REPETIDAS:</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">df_ppl</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">cols_tupl</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
    <span class="n">cols_tupl</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_tupl</span><span class="p">]</span>
    <span class="n">cols_tupl</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_tupl</span><span class="p">]</span>
    <span class="n">cols_tupl</span> <span class="o">=</span> <span class="p">[</span><span class="n">unidecode</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_tupl</span><span class="p">]</span>
    <span class="n">df_ppl</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">cols_tupl</span>

    <span class="c1"># =============================================================</span>

    <span class="n">df_concat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_historico</span><span class="p">,</span> <span class="n">df_ppl</span><span class="p">])</span>
    <span class="c1"># Ordenar la df en funcion de la fecha:</span>
    <span class="n">df_ppl</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;FECHA&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">df_concat</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;FECHA&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Convertirla a string:</span>
    <span class="n">df_concat</span><span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_concat</span><span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y&quot;</span><span class="p">)</span>
    <span class="c1"># Rellenar todos los valores con valores vacios:</span>
    <span class="n">df_concat</span> <span class="o">=</span> <span class="n">df_concat</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># Poner capitalice</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_concat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">df_concat</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>  <span class="c1"># Verificar si la columna contiene texto</span>
          <span class="n">df_concat</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_concat</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">capitalize_text</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_ppl</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">df_ppl</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>  <span class="c1"># Verificar si la columna contiene texto</span>
          <span class="n">df_ppl</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ppl</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">capitalize_text</span><span class="p">)</span>
    <span class="c1"># Escribo documento excel:</span>
    <span class="n">list_dfs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">df_ppl</span><span class="p">,</span> <span class="s1">&#39;PRINCIPAL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">df_concat</span><span class="p">,</span> <span class="s1">&#39;HISTORICO&#39;</span><span class="p">)</span>
              <span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_engine</span><span class="p">(</span><span class="n">list_dfs</span><span class="p">,</span> <span class="n">name_save</span><span class="p">)</span>
    <span class="c1"># Devuelvo info actual + historica:</span>
    <span class="k">return</span> <span class="n">df_ppl</span><span class="p">,</span> <span class="n">df_concat</span></div></div>
<div class="viewcode-block" id="ExcelAdmin2"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelAdmin2">[docs]</a><span class="k">class</span> <span class="nc">ExcelAdmin2</span><span class="p">(</span><span class="n">ExcelPreprocessMain</span><span class="p">):</span>
<div class="viewcode-block" id="ExcelAdmin2.main_siaspp2"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelAdmin2.main_siaspp2">[docs]</a>  <span class="k">def</span> <span class="nf">main_siaspp2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name_pss</span><span class="p">,</span> <span class="n">name_estudiantes_ant</span><span class="p">,</span> <span class="n">name_estudiantes_now</span><span class="p">,</span> <span class="n">name_lists</span><span class="p">,</span> <span class="n">name_save</span><span class="p">,</span> <span class="n">periodo</span><span class="o">=</span><span class="s1">&#39;2022-2S&#39;</span><span class="p">):</span>
    <span class="n">df_pss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name_pss</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># CARGAR PILOS</span>
    <span class="n">df_mib_ant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name_estudiantes_ant</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># CARGAR SIA ANTERIOR</span>
    <span class="n">df_mib_now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name_estudiantes_now</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># CARGAR SIA HOY</span>
    <span class="n">df_hoy_ant</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_mib_now</span><span class="p">,</span> <span class="n">df_mib_ant</span><span class="p">])</span> <span class="c1"># Concatenar sia hoy con anterior</span>
    <span class="n">result_df</span> <span class="o">=</span> <span class="n">df_hoy_ant</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>

    <span class="c1"># Desde aquí...</span>
    <span class="n">col_main</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="c1"># columnas requeridas</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_lists</span><span class="p">:</span>
      <span class="n">df_asig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span> <span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># cargar df asignaturas (este es general)</span>
      <span class="n">col_asig</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_asig</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="c1"># columnas nuevas</span>
      <span class="n">z</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">col_main</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">col_asig</span><span class="p">))</span> <span class="c1"># cols de interseccion</span>
      <span class="n">drop_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">col_asig</span><span class="p">)</span> <span class="o">-</span> <span class="n">z</span> <span class="c1"># quitar las col no interseccion</span>
      <span class="n">df_asing_new</span> <span class="o">=</span> <span class="n">df_asig</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">))</span> <span class="c1"># Borrar todas las no inters</span>
      <span class="n">df_asing_new</span> <span class="o">=</span> <span class="n">df_asing_new</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1"># rellenar nans</span>
      <span class="n">df_asing_new</span> <span class="o">=</span> <span class="n">df_asing_new</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">])</span> <span class="c1"># borrar duplicados by documento</span>
      <span class="n">set_doc_main</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">result_df</span><span class="o">.</span><span class="n">DOCUMENTO</span><span class="p">)</span>
      <span class="n">set_doc_sec</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_asing_new</span><span class="o">.</span><span class="n">DOCUMENTO</span><span class="p">)</span>
      <span class="n">z_doc</span> <span class="o">=</span> <span class="n">set_doc_sec</span> <span class="o">-</span> <span class="n">set_doc_main</span> <span class="c1"># set de cols que no estan </span>
      <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">z_doc</span><span class="p">))</span>
      <span class="c1"># Tomar todas las filas que se encuentran en la lista de las cedulas que no estan en el df</span>
      <span class="c1"># principal y crear una nueva dataframe</span>
      <span class="n">df_asing_new_rest</span> <span class="o">=</span> <span class="n">df_asing_new</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_asing_new</span><span class="p">[</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">z_doc</span><span class="p">))]</span>
      <span class="c1"># Poner PERIODO</span>
      <span class="k">if</span> <span class="s1">&#39;PERIODO&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_asing_new_rest</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df_asing_new_rest</span><span class="o">.</span><span class="n">PERIODO</span> <span class="o">=</span> <span class="n">periodo</span>
      <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">result_df</span><span class="p">,</span> <span class="n">df_asing_new_rest</span><span class="p">])</span>
    <span class="c1"># Continuar con el proceso ....</span>
    <span class="n">df_drop_correo</span> <span class="o">=</span> <span class="n">df_pss</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CORREO&#39;</span><span class="p">])</span>
    <span class="n">df_drop_correo</span><span class="o">.</span><span class="n">DOCUMENTO</span> <span class="o">=</span> <span class="n">df_drop_correo</span><span class="o">.</span><span class="n">DOCUMENTO</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
    <span class="n">df_siaspp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">df_drop_correo</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">)</span>
    <span class="n">df_siaspp</span><span class="p">[</span><span class="s1">&#39;COHORTE&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">df_siaspp</span><span class="p">[</span><span class="s1">&#39;COHORTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;Estudiante Regular&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">df_siaspp</span><span class="p">,</span> <span class="n">name_save</span><span class="p">)</span>
    <span class="n">df_siaspp</span><span class="o">=</span>  <span class="n">df_siaspp</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_siaspp</span></div></div>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">class ExcelFacultades(ExcelPreprocessMain):</span>
<span class="sd">  def main_facultad(self, name_act, name_nod, name_est, name_save, facultad, periodo):</span>
<span class="sd">    df_act = self.load(name_act, 1, 1)</span>
<span class="sd">    df_nod = self.load(name_nod, 1, 1)</span>
<span class="sd">    df_est = self.load(name_est, 1, 1)</span>
<span class="sd">    # col seleccionadas df_act:</span>
<span class="sd">    col_act = [</span>
<span class="sd">        &#39;FACULTAD&#39;,</span>
<span class="sd">        &#39;COD_PLAN&#39;, &#39;PLAN&#39;,</span>
<span class="sd">        &#39;CONVENIO_PLAN&#39;,</span>
<span class="sd">        &#39;COD_NIVEL&#39;, &#39;NIVEL&#39;, &#39;HIST_ACAD&#39;, &#39;AVANCE_CARRERA&#39;, &#39;DOCUMENTO&#39;,</span>
<span class="sd">        &#39;NOMBRES&#39;, &#39;APELLIDO1&#39;, &#39;APELLIDO2&#39;, &#39;NOMBRES_APELLIDOS&#39;, &#39;COD_ACCESO&#39;,</span>
<span class="sd">        &#39;ACCESO&#39;, &#39;COD_SUBACCESO&#39;, &#39;SUBACCESO&#39;, &#39;CONVOCATORIA&#39;, &#39;APERTURA&#39;,</span>
<span class="sd">        &#39;T_DOCUMENTO&#39;, &#39;GENERO&#39;, &#39;EMAIL&#39;, &#39;USUARIO&#39;, &#39;CODIGO&#39;,</span>
<span class="sd">        &#39;FECHA_NACIMIENTO&#39;, &#39;EDAD&#39;, &#39;NUMERO_MATRICULAS&#39;, &#39;PAPA&#39;, &#39;PROME_ACADE&#39;,</span>
<span class="sd">        &#39;PBM_CALCULADO&#39;, &#39;ESTRATO&#39;,&#39;DEPTO_RESIDENCIA&#39;,&#39;MUNICIPIO_RESIDENCIA&#39;, &#39;PAIS-NACIONALIDAD&#39;,</span>
<span class="sd">        &#39;VICTIMAS_DEL_CONFLICTO&#39;, &#39;DISCAPACIDAD&#39;,&#39;COD_NODO_INICIO&#39;, &#39;NODO_INICIO&#39;,&#39;ESTADO&#39;, &#39;CARACTER_COLEGIO&#39;</span>
<span class="sd">    ]</span>
<span class="sd">    df_act = df_act[col_act]</span>
<span class="sd">    # col seleccionadas df_nod:</span>
<span class="sd">    col_nod = [</span>
<span class="sd">        &#39;COD_PROG_CURRICULAR&#39;, &#39;PROG_CURRICULAR&#39;,</span>
<span class="sd">          &#39;COD_FACULTAD&#39;, &#39;FACULTAD&#39;, &#39;TIPO_NIVEL&#39;, &#39;COD_PLAN&#39;, &#39;PLAN&#39;, &#39;NOMBRES&#39;,</span>
<span class="sd">          &#39;APELLIDO1&#39;, &#39;APELLIDO2&#39;, &#39;DOCUMENTO&#39;, &#39;HIST_ACADEMICA&#39;, &#39;EMAIL&#39;,</span>
<span class="sd">          &#39;CONVOCATORIA&#39;, &#39;APERTURA&#39;, &#39;PERIODO_FINALIZACION&#39;,</span>
<span class="sd">          &#39;COD_NODO_FINALIZACION&#39;, &#39;NODO_FINALIZACION&#39;, &#39;PERIODO_GRADUACION&#39;,</span>
<span class="sd">          &#39;COD_NODO_GRADUACION&#39;, &#39;NODO_GRADUACION&#39;, &#39;FECHA_GRADO&#39;, &#39;TITULO&#39;,&#39;PROM_GRADUADO&#39;</span>
<span class="sd">    ]</span>
<span class="sd">    df_nod = df_nod[col_nod]</span>
<span class="sd">    # col seleccionadas df_nod:</span>
<span class="sd">    col_est = [</span>
<span class="sd">        &#39;PERIODO&#39;, &#39;FACULTAD&#39;, &#39;TIPO_NIVEL&#39;,</span>
<span class="sd">        &#39;COD_PLAN&#39;, &#39;PLAN&#39;, </span>
<span class="sd">        &#39;DOCUMENTO&#39;, &#39;NOMBRES&#39;, &#39;APELLIDOS&#39;,</span>
<span class="sd">        &#39;CORREO&#39;, &#39;CONVOCATORIA&#39;, &#39;APERTURA&#39;, &#39;COD_ASIGNATURA&#39;, &#39;ASIGNATURA&#39;,</span>
<span class="sd">        &#39;TIPOLOGIA&#39;, &#39;CREDITOS_ASIGNATURA&#39;,</span>
<span class="sd">        &#39;UAB_ASIGNATURA&#39;,</span>
<span class="sd">        &#39;CALIFICACION_ALFABETICA&#39;, &#39;CALIFICACION_NUMERICA&#39;, &#39;TIPO&#39;,</span>
<span class="sd">        &#39;VECES_VISTA&#39;</span>
<span class="sd">    ]</span>
<span class="sd">    df_est = df_est[col_est]</span>

<span class="sd">    df_act = normalizacion_col(&quot;FACULTAD&quot;, df_act)</span>
<span class="sd">    df_nod = normalizacion_col(&quot;FACULTAD&quot;, df_nod)</span>
<span class="sd">    df_est = normalizacion_col(&quot;FACULTAD&quot;, df_est)</span>

<span class="sd">    df_act_fac = df_act[df_act.FACULTAD == facultad]</span>
<span class="sd">    df_nod_fac = df_nod[df_nod.FACULTAD == facultad]</span>
<span class="sd">    df_est_fac = df_est[df_est.FACULTAD == facultad]</span>

<span class="sd">    </span>

<span class="sd">    try:</span>
<span class="sd">        # nod -&gt; FECHA_GRADO</span>
<span class="sd">        # act -&gt; FECHA_NACIMIENTO</span>
<span class="sd">        df_act_fac[&#39;FECHA_NACIMIENTO&#39;] = df_act_fac[&#39;FECHA_NACIMIENTO&#39;].dt.strftime(&quot;%d/%m/%Y&quot;)</span>
<span class="sd">        df_nod_fac[&#39;FECHA_GRADO&#39;] = df_nod_fac[&#39;FECHA_GRADO&#39;].dt.strftime(&quot;%d/%m/%Y&quot;)</span>
<span class="sd">    except:</span>
<span class="sd">      pass</span>
<span class="sd">    </span>
<span class="sd">    df_act_fac = df_act_fac.fillna(&#39;&#39;)</span>
<span class="sd">    df_nod_fac = df_nod_fac.fillna(&#39;&#39;)</span>
<span class="sd">    df_est_fac = df_est_fac.fillna(&#39;&#39;)</span>

<span class="sd">    # periodo reporte:</span>
<span class="sd">    df_act_fac[&quot;PERIODO_REPORTE&quot;] = periodo</span>
<span class="sd">    df_nod_fac [&quot;PERIODO_REPORTE&quot;] = periodo</span>
<span class="sd">    df_est_fac[&quot;PERIODO_REPORTE&quot;] = periodo</span>

<span class="sd">    # Escribo documento excel:</span>
<span class="sd">    list_dfs = [</span>
<span class="sd">            (df_act_fac, &#39;ACT&#39;),</span>
<span class="sd">            (df_nod_fac, &#39;NOD&#39;),</span>
<span class="sd">            (df_est_fac, &#39;EST&#39;)</span>
<span class="sd">              ]</span>
<span class="sd">    self.write_engine(list_dfs, name_save)</span>
<span class="sd">    return df_act_fac, df_nod_fac, df_est_fac</span>
<span class="sd">&#39;&#39;&#39;</span>


<div class="viewcode-block" id="ExcelFacultades"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelFacultades">[docs]</a><span class="k">class</span> <span class="nc">ExcelFacultades</span><span class="p">(</span><span class="n">ExcelPreprocessMain</span><span class="p">):</span>
<div class="viewcode-block" id="ExcelFacultades.main_facultad"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelFacultades.main_facultad">[docs]</a>  <span class="k">def</span> <span class="nf">main_facultad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_act</span><span class="p">,</span> <span class="n">name_nod</span><span class="p">,</span> <span class="n">name_est</span><span class="p">,</span> <span class="n">name_save</span><span class="p">,</span> <span class="n">facultad</span><span class="p">,</span> <span class="n">periodo</span><span class="p">):</span>
    <span class="n">df_act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name_act</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># col seleccionadas df_act:</span>
    <span class="n">col_act</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;FACULTAD&#39;</span><span class="p">,</span>
        <span class="s1">&#39;COD_PLAN&#39;</span><span class="p">,</span> <span class="s1">&#39;PLAN&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CONVENIO_PLAN&#39;</span><span class="p">,</span>
        <span class="s1">&#39;COD_NIVEL&#39;</span><span class="p">,</span> <span class="s1">&#39;NIVEL&#39;</span><span class="p">,</span> <span class="s1">&#39;HIST_ACAD&#39;</span><span class="p">,</span> <span class="s1">&#39;AVANCE_CARRERA&#39;</span><span class="p">,</span> <span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NOMBRES&#39;</span><span class="p">,</span> <span class="s1">&#39;APELLIDO1&#39;</span><span class="p">,</span> <span class="s1">&#39;APELLIDO2&#39;</span><span class="p">,</span> <span class="s1">&#39;NOMBRES_APELLIDOS&#39;</span><span class="p">,</span> <span class="s1">&#39;COD_ACCESO&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ACCESO&#39;</span><span class="p">,</span> <span class="s1">&#39;COD_SUBACCESO&#39;</span><span class="p">,</span> <span class="s1">&#39;SUBACCESO&#39;</span><span class="p">,</span> <span class="s1">&#39;CONVOCATORIA&#39;</span><span class="p">,</span> <span class="s1">&#39;APERTURA&#39;</span><span class="p">,</span>
        <span class="s1">&#39;T_DOCUMENTO&#39;</span><span class="p">,</span> <span class="s1">&#39;GENERO&#39;</span><span class="p">,</span> <span class="s1">&#39;EMAIL&#39;</span><span class="p">,</span> <span class="s1">&#39;USUARIO&#39;</span><span class="p">,</span> <span class="s1">&#39;CODIGO&#39;</span><span class="p">,</span>
        <span class="s1">&#39;FECHA_NACIMIENTO&#39;</span><span class="p">,</span> <span class="s1">&#39;EDAD&#39;</span><span class="p">,</span> <span class="s1">&#39;NUMERO_MATRICULAS&#39;</span><span class="p">,</span> <span class="s1">&#39;PAPA&#39;</span><span class="p">,</span> <span class="s1">&#39;PROME_ACADE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PBM_CALCULADO&#39;</span><span class="p">,</span> <span class="s1">&#39;ESTRATO&#39;</span><span class="p">,</span><span class="s1">&#39;DEPTO_RESIDENCIA&#39;</span><span class="p">,</span><span class="s1">&#39;MUNICIPIO_RESIDENCIA&#39;</span><span class="p">,</span> <span class="s1">&#39;PAIS-NACIONALIDAD&#39;</span><span class="p">,</span>
        <span class="s1">&#39;VICTIMAS_DEL_CONFLICTO&#39;</span><span class="p">,</span> <span class="s1">&#39;DISCAPACIDAD&#39;</span><span class="p">,</span><span class="s1">&#39;COD_NODO_INICIO&#39;</span><span class="p">,</span> <span class="s1">&#39;NODO_INICIO&#39;</span><span class="p">,</span><span class="s1">&#39;ESTADO&#39;</span><span class="p">,</span> <span class="s1">&#39;CARACTER_COLEGIO&#39;</span>
    <span class="p">]</span>
    <span class="n">df_act</span> <span class="o">=</span> <span class="n">df_act</span><span class="p">[</span><span class="n">col_act</span><span class="p">]</span>
    <span class="n">df_act</span> <span class="o">=</span> <span class="n">normalizacion_col</span><span class="p">(</span><span class="s2">&quot;FACULTAD&quot;</span><span class="p">,</span> <span class="n">df_act</span><span class="p">)</span>
    <span class="n">df_act_fac</span> <span class="o">=</span> <span class="n">df_act</span><span class="p">[</span><span class="n">df_act</span><span class="o">.</span><span class="n">FACULTAD</span> <span class="o">==</span> <span class="n">facultad</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># nod -&gt; FECHA_GRADO</span>
        <span class="c1"># act -&gt; FECHA_NACIMIENTO</span>
        <span class="n">df_act_fac</span><span class="p">[</span><span class="s1">&#39;FECHA_NACIMIENTO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_act_fac</span><span class="p">[</span><span class="s1">&#39;FECHA_NACIMIENTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">pass</span>
    <span class="n">df_act_fac</span> <span class="o">=</span> <span class="n">df_act_fac</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># periodo reporte:</span>
    <span class="n">df_act_fac</span><span class="p">[</span><span class="s2">&quot;PERIODO_REPORTE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">periodo</span>
    <span class="c1"># Escribo documento excel:</span>
    <span class="n">list_dfs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">df_act_fac</span><span class="p">,</span> <span class="s1">&#39;ACT&#39;</span><span class="p">)</span>
              <span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_engine</span><span class="p">(</span><span class="n">list_dfs</span><span class="p">,</span> <span class="n">name_save</span><span class="p">)</span>

    <span class="c1"># dummy:</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df_act_fac</span><span class="p">,</span> <span class="n">df1</span><span class="p">,</span> <span class="n">df2</span></div></div>



<div class="viewcode-block" id="ExcelSia"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelSia">[docs]</a><span class="k">class</span> <span class="nc">ExcelSia</span><span class="p">(</span><span class="n">ExcelPreprocessMain</span><span class="p">):</span>
<div class="viewcode-block" id="ExcelSia.main_matriculados"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelSia.main_matriculados">[docs]</a>  <span class="k">def</span> <span class="nf">main_matriculados</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name_asignaturas</span><span class="p">,</span><span class="n">name_estudiantes_now</span><span class="p">,</span><span class="n">name_estudiantes_ant</span><span class="p">,</span><span class="n">name_matr_ib</span><span class="p">,</span> <span class="n">name_matr_pp</span><span class="p">,</span> <span class="n">name_save</span><span class="p">,</span> <span class="n">periodo</span><span class="p">,</span> <span class="n">df_historico</span><span class="p">):</span>
    <span class="n">PATH_PRINCIPAL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
    <span class="c1"># Asignarutas inscritas:</span>
    <span class="n">path_1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_PRINCIPAL</span><span class="p">,</span><span class="n">name_asignaturas</span><span class="p">)</span>
    <span class="n">df_asignaturas_inscritas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">path_1</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Filtrar cedulas distintas por inscritos:</span>
    <span class="n">set_docs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_asignaturas_inscritas</span><span class="p">[</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
    <span class="c1">#set_docs = list(set_docs)[:nn] # SOLO HASTA 50</span>
    <span class="c1"># Cargar Informacion básica 2022 - 2s:</span>
    <span class="n">path_2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_PRINCIPAL</span><span class="p">,</span> <span class="n">name_estudiantes_now</span><span class="p">)</span>
    <span class="n">df_mib_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">path_2</span><span class="p">,</span><span class="n">sheet_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Cargar Informacion básica 2022-1s:</span>
    <span class="n">path_3</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_PRINCIPAL</span><span class="p">,</span> <span class="n">name_estudiantes_ant</span><span class="p">)</span>
    <span class="n">df_mib_ant</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">path_3</span><span class="p">,</span><span class="n">sheet_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Cargar Matriculados Info Básica:</span>
    <span class="n">path_4</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_PRINCIPAL</span><span class="p">,</span> <span class="n">name_matr_ib</span><span class="p">)</span>
    <span class="n">df_MIB</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">path_4</span><span class="p">,</span><span class="n">sheet_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Cargar Matriculados por periodo:</span>
    <span class="n">path_5</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_PRINCIPAL</span><span class="p">,</span> <span class="n">name_matr_pp</span><span class="p">)</span>
    <span class="n">df_MPP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">path_5</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======================================&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TODAS LAS BASES DE DATOS CARGADAS. :) &#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======================================&quot;</span><span class="p">)</span>
    <span class="c1"># CRUCE:</span>
    <span class="c1"># Listas vacias por caracteristica:</span>
    <span class="n">Creditos_inscritos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Genero</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Depart_nacimiento</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Cedula</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Cod_plan</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Plan</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Avance</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Tipo_de_Nivel</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Convocatoria</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Apertura</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># CRUCE:</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">dni</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">set_docs</span><span class="p">):</span>
      <span class="c1"># INSCRITOS:</span>
      <span class="n">creditos_totales</span> <span class="o">=</span> <span class="n">DNI_2_TotCred</span><span class="p">(</span><span class="n">dni</span><span class="p">,</span> <span class="n">df_asignaturas_inscritas</span><span class="p">)</span>
      <span class="c1"># COD_PLAN</span>
      <span class="n">cod_plan</span> <span class="o">=</span> <span class="n">DNI_2_Feature</span><span class="p">(</span><span class="n">dni</span><span class="p">,</span> <span class="s1">&#39;COD_PLAN&#39;</span><span class="p">,</span> <span class="n">df_asignaturas_inscritas</span><span class="p">)</span>
      <span class="c1"># PLAN</span>
      <span class="n">plan</span> <span class="o">=</span> <span class="n">DNI_2_Feature</span><span class="p">(</span><span class="n">dni</span><span class="p">,</span> <span class="s1">&#39;PLAN&#39;</span><span class="p">,</span> <span class="n">df_asignaturas_inscritas</span><span class="p">)</span>
      <span class="c1"># TIPO DE NIVEL TIPO_NIVEL</span>
      <span class="n">tipo_nivel</span> <span class="o">=</span> <span class="n">DNI_2_Feature</span><span class="p">(</span><span class="n">dni</span><span class="p">,</span> <span class="s1">&#39;TIPO_NIVEL&#39;</span><span class="p">,</span> <span class="n">df_asignaturas_inscritas</span><span class="p">)</span>
      <span class="c1"># CONVOCATORIA:</span>
      <span class="n">convocatoria</span> <span class="o">=</span> <span class="n">DNI_2_Feature</span><span class="p">(</span><span class="n">dni</span><span class="p">,</span> <span class="s1">&#39;CONVOCATORIA&#39;</span><span class="p">,</span> <span class="n">df_asignaturas_inscritas</span><span class="p">)</span>
      <span class="c1"># APERTURA:</span>
      <span class="n">apertura</span> <span class="o">=</span> <span class="n">DNI_2_Feature</span><span class="p">(</span><span class="n">dni</span><span class="p">,</span> <span class="s1">&#39;APERTURA&#39;</span><span class="p">,</span> <span class="n">df_asignaturas_inscritas</span><span class="p">)</span>
      <span class="c1"># SEXO:</span>
      <span class="n">sexo</span> <span class="o">=</span> <span class="n">DNI_2_Feature</span><span class="p">(</span><span class="n">dni</span><span class="p">,</span> <span class="s1">&#39;SEXO&#39;</span><span class="p">,</span> <span class="n">df_mib_ant</span><span class="p">)</span> <span class="c1"># &#39;M&#39;, &#39;F&#39;, &#39;INDEFINIDO&#39;</span>
      <span class="k">if</span> <span class="n">sexo</span> <span class="o">==</span> <span class="s1">&#39;INDEFINIDO&#39;</span><span class="p">:</span>
        <span class="n">sexo</span> <span class="o">=</span> <span class="n">DNI_2_Feature</span><span class="p">(</span><span class="n">dni</span><span class="p">,</span> <span class="s1">&#39;SEXO&#39;</span><span class="p">,</span> <span class="n">df_mib_now</span><span class="p">)</span> <span class="c1"># &#39;M&#39;, &#39;F&#39;, &#39;INDEFINIDO&#39;</span>
      <span class="c1"># DEPARTAMENTO:</span>
      <span class="n">departamento</span> <span class="o">=</span> <span class="n">DNI_2_Feature</span><span class="p">(</span><span class="n">dni</span><span class="p">,</span> <span class="s1">&#39;DEPARTAMENTO_PROCEDENCIA&#39;</span><span class="p">,</span> <span class="n">df_MPP</span><span class="p">)</span> <span class="c1"># DEP o INDEFINIDO</span>
      <span class="c1"># AVANCE_CARRERA</span>
      <span class="c1"># df_basicos </span>
      <span class="c1"># df_MPP</span>
      <span class="c1"># df_matriculados</span>
      <span class="n">prc</span> <span class="o">=</span> <span class="n">DNI_2_Feature</span><span class="p">(</span><span class="n">dni</span><span class="p">,</span> <span class="s1">&#39;AVANCE_CARRERA&#39;</span><span class="p">,</span> <span class="n">df_mib_now</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">prc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">5</span><span class="p">:</span>
        <span class="n">prc</span> <span class="o">=</span> <span class="n">DNI_2_Feature</span><span class="p">(</span><span class="n">dni</span><span class="p">,</span> <span class="s1">&#39;AVANCE_CARRERA&#39;</span><span class="p">,</span> <span class="n">df_mib_ant</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">5</span><span class="p">:</span>
          <span class="n">prc</span> <span class="o">=</span> <span class="n">DNI_2_Feature</span><span class="p">(</span><span class="n">dni</span><span class="p">,</span> <span class="s1">&#39;AVANCE_CARRERA&#39;</span><span class="p">,</span><span class="n">df_MIB</span><span class="p">)</span>
      <span class="c1"># AGREGAR:</span>
      <span class="n">Cedula</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dni</span><span class="p">)</span>
      <span class="n">Creditos_inscritos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">creditos_totales</span><span class="p">)</span>
      <span class="n">Genero</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sexo</span><span class="p">)</span>
      <span class="n">Depart_nacimiento</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">departamento</span><span class="p">)</span>
      <span class="n">Cod_plan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cod_plan</span><span class="p">)</span>
      <span class="n">Plan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
      <span class="n">Avance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prc</span><span class="p">)</span>
      <span class="n">Tipo_de_Nivel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tipo_nivel</span><span class="p">)</span>
      <span class="n">Convocatoria</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convocatoria</span><span class="p">)</span>
      <span class="n">Apertura</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">apertura</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======================================&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CRUCE REALIZADO! :) &#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======================================&quot;</span><span class="p">)</span>
    <span class="c1"># Crear dataframe final:</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;CEDULA&#39;</span><span class="p">:</span> <span class="n">Cedula</span><span class="p">,</span>
        <span class="s1">&#39;SEXO&#39;</span><span class="p">:</span> <span class="n">Genero</span><span class="p">,</span>
        <span class="s1">&#39;TOTAL_CREDITOS&#39;</span><span class="p">:</span> <span class="n">Creditos_inscritos</span><span class="p">,</span>
        <span class="s1">&#39;DEPARTAMENTO&#39;</span><span class="p">:</span><span class="n">Depart_nacimiento</span><span class="p">,</span>
        <span class="s1">&#39;COD_PLAN&#39;</span><span class="p">:</span><span class="n">Cod_plan</span><span class="p">,</span>
        <span class="s1">&#39;PLAN&#39;</span><span class="p">:</span><span class="n">Plan</span><span class="p">,</span>
        <span class="s1">&#39;AVANCE&#39;</span><span class="p">:</span><span class="n">Avance</span><span class="p">,</span>
        <span class="s1">&#39;NIVEL_ESTUDIOS&#39;</span><span class="p">:</span><span class="n">Tipo_de_Nivel</span><span class="p">,</span>
        <span class="s1">&#39;CONVOCATORIA&#39;</span><span class="p">:</span><span class="n">Convocatoria</span><span class="p">,</span>
        <span class="s1">&#39;APERTURA&#39;</span><span class="p">:</span><span class="n">Apertura</span>
    <span class="p">})</span>
    <span class="c1"># Borrar NAN en df1</span>
    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;PERIODO_REPORTE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">periodo</span>

    <span class="n">df_concat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_historico</span><span class="p">,</span> <span class="n">df1</span><span class="p">])</span>
    <span class="n">df_concat</span> <span class="o">=</span> <span class="n">df_concat</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">list_dfs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="s1">&#39;PRINCIPAL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">df_concat</span><span class="p">,</span> <span class="s1">&#39;HISTORICO&#39;</span><span class="p">)</span>
              <span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_engine</span><span class="p">(</span><span class="n">list_dfs</span><span class="p">,</span> <span class="n">name_save</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_concat</span></div>
  
<div class="viewcode-block" id="ExcelSia.estadisticas_1"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelSia.estadisticas_1">[docs]</a>  <span class="k">def</span> <span class="nf">estadisticas_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_sia_grphor</span><span class="p">):</span>
    <span class="c1"># cargar horarios y grupos:</span>
    <span class="n">df_hr_gr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name_sia_grphor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ubgga_ass</span> <span class="o">=</span> <span class="n">df_hr_gr</span><span class="p">[</span><span class="s1">&#39;UBGAA_ASS&#39;</span><span class="p">]</span>
    <span class="c1"># Campos:</span>
    <span class="n">departamento</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">asignaturas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">grupos</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="n">cupos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">inscritos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Departamentos:</span>
    <span class="n">Departamentos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ubgga_ass</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">Departamentos</span><span class="p">:</span>
      <span class="c1"># por cada departamento tomar un trozo de datos:</span>
      <span class="n">df</span> <span class="o">=</span> <span class="n">df_hr_gr</span><span class="p">[</span><span class="n">df_hr_gr</span><span class="p">[</span><span class="s1">&#39;UBGAA_ASS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dep</span><span class="p">]</span>
      <span class="c1"># tomar nombre se asignatura, id grupo, cupo y numero de inscritos:</span>
      <span class="n">df_asignaturas</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;NOMBRE_ASS&#39;</span><span class="p">]</span>
      <span class="c1"># (Correccion: hacer set teniendo en cuenta la asignatura, porque los grupos pueden ser llamados igual)</span>
      <span class="n">n_asg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df_asignaturas</span><span class="p">))</span> <span class="c1"># Numero de asignaturas distintas.</span>
      <span class="c1"># Numero de grupos distintos</span>
      <span class="n">grup</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;NOMBRE_ASS&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;PPAL_ID_GRUPO_ACTIVIDAD&#39;</span><span class="p">]</span>
      <span class="n">df_grupos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">grup</span><span class="p">)</span>
      <span class="n">n_grup</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_grupos</span><span class="p">)</span>
      <span class="c1"># Numero de cupos:</span>
      <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      n_cupo = df_cupo.sum()</span>
<span class="sd">      n_inscritos = df_inscritos_.sum()</span>
<span class="sd">      # </span>
<span class="sd">      &#39;&#39;&#39;</span>
      <span class="n">departamento</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
      <span class="n">asignaturas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_asg</span><span class="p">)</span>
      <span class="c1">#grupos.append(n_grup)</span>
      <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      cupos.append(n_cupo)</span>
<span class="sd">      inscritos.append(n_inscritos)</span>
<span class="sd">      &#39;&#39;&#39;</span>
    <span class="n">ASIGNATURAS_OFERTADAS_PERIOD</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;DEPARTAMENTO&#39;</span><span class="p">:</span><span class="n">departamento</span><span class="p">,</span>
        <span class="s1">&#39;ASIGNATURAS&#39;</span><span class="p">:</span> <span class="n">asignaturas</span>
        <span class="c1">#&#39;GRUPOS&#39;: grupos</span>
          <span class="p">})</span>
        <span class="c1">#&#39;CUPOS&#39;: cupos,</span>
        <span class="c1">#&#39;INSCRITOS&#39;:inscritos</span>
        
    <span class="k">return</span> <span class="n">ASIGNATURAS_OFERTADAS_PERIOD</span></div>
<div class="viewcode-block" id="ExcelSia.inscritos_nivel"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelSia.inscritos_nivel">[docs]</a>  <span class="k">def</span> <span class="nf">inscritos_nivel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name_sia_asignaturas</span><span class="p">,</span> <span class="n">tipo_nivel</span><span class="p">,</span> <span class="n">semestre_actual</span><span class="p">):</span>
    <span class="c1"># tomo pregrado:</span>
    <span class="c1"># (poner nivel como una varible):</span>
    <span class="n">df_inscritos</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name_sia_asignaturas</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># CARGAR SIA ANTERIOR</span>
    <span class="n">df_by_nivel</span> <span class="o">=</span> <span class="n">df_inscritos</span><span class="p">[</span><span class="n">df_inscritos</span><span class="p">[</span><span class="s1">&#39;TIPO_NIVEL&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tipo_nivel</span><span class="p">]</span>
    <span class="c1"># selecciono dni set:</span>
    <span class="n">dnis</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_by_nivel</span><span class="p">[</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
    <span class="c1"># preparo listas:</span>
    <span class="n">plan_now</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cedula_now</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">apertura_now</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">plan_before</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cedula_before</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">apertura_before</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># para c/u cedulas...</span>
    <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">dnis</span><span class="p">:</span>
      <span class="c1"># obtengo su &quot;fila&quot;...</span>
      <span class="n">df_estudiante</span> <span class="o">=</span> <span class="n">df_by_nivel</span><span class="p">[</span><span class="n">df_by_nivel</span><span class="p">[</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cc</span><span class="p">]</span>
      <span class="c1"># Si estudiante esta en convocatoria y aperturas semestre actual... (Poner semestre como una variable)</span>
      <span class="c1"># solo apertura ... sufiente</span>
      <span class="k">if</span> <span class="n">df_estudiante</span><span class="p">[</span><span class="s1">&#39;CONVOCATORIA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">semestre_actual</span> <span class="ow">and</span> <span class="n">df_estudiante</span><span class="p">[</span><span class="s1">&#39;APERTURA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">semestre_actual</span><span class="p">:</span>
        <span class="c1"># Obtengo su plan y lo guardo en planes</span>
        <span class="n">plan_now</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_estudiante</span><span class="p">[</span><span class="s1">&#39;PLAN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># tambien guardo su cedula:</span>
        <span class="n">cedula_now</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
        <span class="n">apertura_now</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_estudiante</span><span class="p">[</span><span class="s1">&#39;APERTURA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">elif</span> <span class="n">df_estudiante</span><span class="p">[</span><span class="s1">&#39;APERTURA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">semestre_actual</span><span class="p">:</span>
        <span class="n">plan_before</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_estudiante</span><span class="p">[</span><span class="s1">&#39;PLAN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">cedula_before</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
        <span class="n">apertura_before</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_estudiante</span><span class="p">[</span><span class="s1">&#39;APERTURA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># guardo en diccionario informacion:</span>
    <span class="n">INSCRITOS_ANTIGUOS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;PLAN&#39;</span><span class="p">:</span> <span class="n">plan_before</span><span class="p">,</span>
        <span class="s1">&#39;CEDULA&#39;</span><span class="p">:</span> <span class="n">cedula_before</span><span class="p">,</span>
        <span class="s1">&#39;APERTURA&#39;</span><span class="p">:</span> <span class="n">apertura_before</span>
    <span class="p">}</span>
    <span class="n">INSCRITOS_NUEVOS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;PLAN&#39;</span><span class="p">:</span> <span class="n">plan_now</span><span class="p">,</span>
        <span class="s1">&#39;CEDULA&#39;</span><span class="p">:</span> <span class="n">cedula_now</span><span class="p">,</span>
        <span class="s1">&#39;APERTURA&#39;</span><span class="p">:</span> <span class="n">apertura_now</span>
    <span class="p">}</span>
    <span class="c1"># Escribo como datagrame plan y cedula...</span>
    <span class="n">df_INSCRITOS_ANTIGUOS</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">INSCRITOS_ANTIGUOS</span><span class="p">)</span>
    <span class="n">df_INSCRITOS_NUEVOS</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">INSCRITOS_NUEVOS</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">df_INSCRITOS_NUEVOS</span><span class="p">,</span> <span class="n">df_INSCRITOS_ANTIGUOS</span><span class="p">]</span></div>

<div class="viewcode-block" id="ExcelSia.proyectos_tesis"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelSia.proyectos_tesis">[docs]</a>  <span class="k">def</span> <span class="nf">proyectos_tesis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name_sia_asignaturas</span><span class="p">,</span> <span class="n">name_sia_grphor</span><span class="p">,</span> <span class="n">name_save</span><span class="p">):</span>
    <span class="n">df_inscritos</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name_sia_asignaturas</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># CARGAR SIA ANTERIOR</span>
    <span class="n">df_hr_gr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name_sia_grphor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">df_hr_gr_filtered</span> <span class="o">=</span> <span class="n">df_hr_gr</span><span class="p">[[</span>
                                <span class="s1">&#39;ID_ASSIGNATURA&#39;</span><span class="p">,</span> <span class="c1"># id asignatura</span>
                                <span class="s1">&#39;NOMBRE_ASS&#39;</span><span class="p">,</span> <span class="c1"># nombre asignatura</span>
                                <span class="s1">&#39;PPAL_ID_GRUPO_ACTIVIDAD&#39;</span><span class="p">,</span> <span class="c1"># id grupo</span>
                                <span class="s1">&#39;PPAL_DESC_GRUPO_ACTIVIDAD&#39;</span><span class="p">,</span> <span class="c1"># descripcion grupo</span>
                                <span class="s1">&#39;PPAL_NUM_INSCRITOS&#39;</span><span class="p">,</span> <span class="c1"># numero de inscritos</span>
                                <span class="s1">&#39;PPAL_DOC_DOCENTE&#39;</span><span class="p">,</span> <span class="c1"># documento docente</span>
                                <span class="s1">&#39;PPAL_NOMPRS&#39;</span> <span class="c1"># nombre docente</span>
                            <span class="p">]]</span>
    <span class="n">df_hr_gr_filtered</span> <span class="o">=</span> <span class="n">df_hr_gr_filtered</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1"># llenar nan con espacio texto vacio.</span>
    <span class="c1"># Columnas necesarias para inscritos</span>
    <span class="n">df_inscritos_filtered</span> <span class="o">=</span> <span class="n">df_inscritos</span><span class="p">[[</span>
                                        <span class="s1">&#39;COD_PLAN&#39;</span><span class="p">,</span> <span class="c1"># codigo plan</span>
                                        <span class="s1">&#39;PLAN&#39;</span><span class="p">,</span> <span class="c1"># plan</span>
                                        <span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">,</span> <span class="c1"># documento</span>
                                        <span class="s1">&#39;NOMBRES&#39;</span><span class="p">,</span> <span class="c1"># nombres</span>
                                        <span class="s1">&#39;APELLIDOS&#39;</span><span class="p">,</span> <span class="c1"># apellidos</span>
                                        <span class="s1">&#39;CORREO&#39;</span><span class="p">,</span> <span class="c1"># correo</span>
                                        <span class="s1">&#39;COD_ASIGNATURA&#39;</span><span class="p">,</span> <span class="c1"># cod asignatura</span>
                                        <span class="s1">&#39;ASIGNATURA&#39;</span><span class="p">,</span> <span class="c1"># asignatura</span>
                                        <span class="s1">&#39;GRUPO_ASIGNATURA&#39;</span> <span class="c1"># grupo asignatura</span>
                                        <span class="p">]]</span>
    <span class="n">df_inscritos_filtered</span> <span class="o">=</span> <span class="n">df_inscritos_filtered</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="c1"># llenar nan con espacio texto vacio.</span>
    <span class="n">df_inscritos_filtered</span><span class="p">[</span><span class="s1">&#39;DOCENTE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># creo una columna que se llame docente...</span>

    <span class="n">list_tesis_proyectos</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s2">&quot;TRABAJO FINAL&quot;</span><span class="p">,</span>
      <span class="s2">&quot;TRABAJO FINAL DE MAESTRIA&quot;</span><span class="p">,</span>
      <span class="s2">&quot;TESIS DE MAESTRIA&quot;</span><span class="p">,</span>
      <span class="s2">&quot;PROYECTO DE TESIS DE DOCTORADO&quot;</span><span class="p">,</span>
      <span class="s2">&quot;TESIS DE DOCTORADO&quot;</span><span class="p">,</span>
      <span class="s2">&quot;TESIS&quot;</span><span class="p">,</span>
      <span class="s2">&quot;TRABAJO FINAL DE MAESTRÍA&quot;</span><span class="p">,</span>
      <span class="s2">&quot;PROYECTO DE TESIS&quot;</span><span class="p">,</span>
      <span class="s2">&quot;TESIS DE MAESTRÍA&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">index_drop</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># lista vacia</span>

    <span class="c1"># Recorrer por filas a inscritos...</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_inscritos_filtered</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
      <span class="c1"># Tomo codigo de asignatura:</span>
      <span class="n">asignatura</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;COD_ASIGNATURA&#39;</span><span class="p">]</span>
      <span class="c1"># Tomo el grupo:</span>
      <span class="n">grupo</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GRUPO_ASIGNATURA&#39;</span><span class="p">]</span>
      <span class="c1"># Busco en grupos y horarios lugares donde coincida asignatura:</span>
      <span class="n">tf_doc_asignatura</span> <span class="o">=</span> <span class="n">df_hr_gr_filtered</span><span class="p">[</span><span class="s1">&#39;ID_ASSIGNATURA&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">asignatura</span>
      <span class="c1"># Busco en grupos y horarios lugares donde coincida grupo:</span>
      <span class="n">tf_doc_grupo</span> <span class="o">=</span> <span class="n">df_hr_gr_filtered</span><span class="p">[</span><span class="s1">&#39;PPAL_ID_GRUPO_ACTIVIDAD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grupo</span>
      <span class="c1"># Busco en horarios y grupos la coincidencia mutua (AND):</span>
      <span class="n">df_docente</span> <span class="o">=</span> <span class="n">df_hr_gr_filtered</span><span class="p">[</span><span class="n">tf_doc_asignatura</span> <span class="o">&amp;</span> <span class="n">tf_doc_grupo</span><span class="p">]</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Intento capturar el nombre de la asignatura:</span>
        <span class="n">asg</span> <span class="o">=</span> <span class="n">df_docente</span><span class="p">[</span><span class="s1">&#39;NOMBRE_ASS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># valido si esa asignatura pertenece a la lista de asignaturas necesarias:</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">valid_asignature</span><span class="p">(</span><span class="n">asg</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">list_tesis_proyectos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tf</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># si pertenece</span>
        <span class="c1"># Se extrae el nombre del docente:</span>
          <span class="n">docente_nombre</span> <span class="o">=</span> <span class="n">df_docente</span><span class="p">[</span><span class="s1">&#39;PPAL_NOMPRS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Se lo guarda en la col. creada llamada docente</span>
          <span class="n">row</span><span class="p">[</span><span class="s1">&#39;DOCENTE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">docente_nombre</span>
        <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Sino entonces guardo indices para dropear</span>
          <span class="n">index_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="c1"># Se ven tantos 0 porque es cuando no se encuentran coincidencias </span>
        <span class="c1"># e igual se guarda el indice para dropear:</span>
          <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_docente</span><span class="p">))</span> 
          <span class="n">index_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># dropeo dataframe con las filas que no tienen la informacion requerida:</span>
    <span class="n">df_inscritos_filtered</span> <span class="o">=</span> <span class="n">df_inscritos_filtered</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index_drop</span><span class="p">)</span>

    <span class="n">list_dfs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">df_inscritos_filtered</span><span class="p">,</span> <span class="s1">&#39;PRINCIPAL&#39;</span><span class="p">)</span>
              <span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_engine</span><span class="p">(</span><span class="n">list_dfs</span><span class="p">,</span> <span class="n">name_save</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_inscritos_filtered</span></div>

<div class="viewcode-block" id="ExcelSia.tutores"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.ExcelSia.tutores">[docs]</a>  <span class="k">def</span> <span class="nf">tutores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name_tutores</span><span class="p">,</span> <span class="n">name_save</span><span class="p">,</span> <span class="n">name_matriculados</span><span class="p">):</span>

    <span class="n">df_tutores</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name_tutores</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># CARGAR SIA ANTERIOR</span>
    <span class="n">df_tutores</span> <span class="o">=</span> <span class="n">df_tutores</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">planes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_tutores</span><span class="p">[</span><span class="s1">&#39;PLAN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>

    <span class="c1"># Matriculados:</span>
    <span class="n">df_matriculados</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name_matriculados</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">df_nombres_apellidos</span> <span class="o">=</span> <span class="n">df_matriculados</span><span class="p">[[</span><span class="s2">&quot;NOMBRES&quot;</span><span class="p">,</span> <span class="s2">&quot;APELLIDO1&quot;</span><span class="p">,</span> <span class="s2">&quot;APELLIDO2&quot;</span><span class="p">]]</span>
    <span class="n">df_nombres_apellidos</span><span class="p">[</span><span class="s2">&quot;COMPLETO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nombres_apellidos</span><span class="p">[</span><span class="s2">&quot;NOMBRES&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">df_nombres_apellidos</span><span class="p">[</span><span class="s2">&quot;APELLIDO1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">df_nombres_apellidos</span><span class="p">[</span><span class="s2">&quot;APELLIDO2&quot;</span><span class="p">]</span>
    <span class="n">df_nombres_apellidos</span> <span class="o">=</span> <span class="n">df_nombres_apellidos</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">df_nombres_apellidos</span><span class="p">[</span><span class="s2">&quot;COMPLETO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nombres_apellidos</span><span class="p">[</span><span class="s2">&quot;COMPLETO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">df_nombres_apellidos</span><span class="p">[</span><span class="s2">&quot;COMPLETO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nombres_apellidos</span><span class="p">[</span><span class="s2">&quot;COMPLETO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">unidecode</span><span class="p">)</span>
    <span class="n">df_nombres_apellidos</span><span class="p">[</span><span class="s2">&quot;COMPLETO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nombres_apellidos</span><span class="p">[</span><span class="s2">&quot;COMPLETO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">matriculados_nombre</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_nombres_apellidos</span><span class="p">[</span><span class="s2">&quot;COMPLETO&quot;</span><span class="p">])</span>

    <span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">todo</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">planes</span><span class="p">:</span>
      <span class="c1"># plan i:</span>
      <span class="n">df_matriculados_3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
      
      <span class="k">try</span><span class="p">:</span>
        <span class="n">name_estudiantes</span> <span class="o">=</span> <span class="s2">&quot;ESTUDIANTES_&quot;</span> <span class="o">+</span> <span class="n">plan</span> <span class="o">+</span> <span class="s2">&quot;.xlsx&quot;</span>
        <span class="n">name_estudiantes</span> <span class="o">=</span> <span class="n">name_estudiantes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">name_estudiantes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;sia&#39;</span><span class="p">,</span><span class="s1">&#39;subidos&#39;</span><span class="p">,</span><span class="n">name_estudiantes</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">name_estudiantes</span><span class="p">))</span>
        <span class="n">df_estudiantes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name_estudiantes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">df_estudiantes</span> <span class="o">=</span> <span class="n">df_estudiantes</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">df_estudiantes</span><span class="p">[</span><span class="s2">&quot;NOMBRES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_estudiantes</span><span class="p">[</span><span class="s2">&quot;NOMBRES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">df_estudiantes</span><span class="p">[</span><span class="s2">&quot;NOMBRES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_estudiantes</span><span class="p">[</span><span class="s2">&quot;NOMBRES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">unidecode</span><span class="p">)</span>
        <span class="n">df_estudiantes</span><span class="p">[</span><span class="s2">&quot;NOMBRES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_estudiantes</span><span class="p">[</span><span class="s2">&quot;NOMBRES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">df_estudiantes_R</span> <span class="o">=</span> <span class="n">df_estudiantes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_estudiantes</span><span class="p">[</span><span class="s2">&quot;NOMBRES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">matriculados_nombre</span><span class="p">))]</span>
        <span class="n">nombres_r</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_estudiantes_R</span><span class="o">.</span><span class="n">NOMBRES</span><span class="p">)</span>
        <span class="n">df_matriculados_2</span> <span class="o">=</span> <span class="n">df_matriculados</span><span class="p">[</span><span class="n">df_nombres_apellidos</span><span class="p">[</span><span class="s2">&quot;COMPLETO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">nombres_r</span><span class="p">)]</span>
        <span class="n">df_matriculados_2</span><span class="p">[</span><span class="s2">&quot;APELLIDOS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_matriculados_2</span><span class="p">[</span><span class="s2">&quot;APELLIDO1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">df_matriculados_2</span><span class="p">[</span><span class="s2">&quot;APELLIDO2&quot;</span><span class="p">]</span>
        <span class="c1"># cambiar nombre cols</span>
        <span class="n">df_matriculados_2</span><span class="p">[</span><span class="s2">&quot;CORREO ESTUDIANTE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_matriculados_2</span><span class="p">[</span><span class="s2">&quot;CORREO&quot;</span><span class="p">]</span>
        <span class="n">df_matriculados_2</span><span class="p">[</span><span class="s2">&quot;PERIODO_CONVOCATORIA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_matriculados_2</span><span class="p">[</span><span class="s2">&quot;CONVOCATORIA&quot;</span><span class="p">]</span>
        <span class="n">df_matriculados_2</span><span class="p">[</span><span class="s2">&quot;PERIODO_APERTURA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_matriculados_2</span><span class="p">[</span><span class="s2">&quot;APERTURA&quot;</span><span class="p">]</span>
        <span class="c1"># col intesection</span>
        <span class="n">col_tut</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_tutores</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">col_matri</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_matriculados_2</span><span class="p">)</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">col_tut</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">col_matri</span><span class="p">)</span>
        <span class="n">df_matriculados_3</span> <span class="o">=</span> <span class="n">df_matriculados_2</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cc</span><span class="p">)]</span>
        
      <span class="k">except</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No se encontro </span><span class="si">{</span><span class="n">name_estudiantes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

      <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df_tutores</span><span class="p">[</span><span class="n">df_tutores</span><span class="p">[</span><span class="s1">&#39;PLAN&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">plan</span><span class="p">]</span>
      <span class="n">df_con_tutor</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="p">[</span><span class="n">df_filtered</span><span class="p">[</span><span class="s1">&#39;TUTOR&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
      <span class="n">df_sin_tutor</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="p">[</span><span class="n">df_filtered</span><span class="p">[</span><span class="s1">&#39;TUTOR&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">plan</span> <span class="o">==</span> <span class="s1">&#39;ADMINISTRACION DE EMPRESAS (N)&#39;</span><span class="p">:</span>
          <span class="n">plan</span> <span class="o">=</span> <span class="s1">&#39;ADMIN EMPRESAS (N)&#39;</span>
      <span class="k">elif</span> <span class="n">plan</span> <span class="o">==</span> <span class="s1">&#39;ADMINISTRACION DE EMPRESAS (D)&#39;</span><span class="p">:</span>
          <span class="n">plan</span> <span class="o">=</span> <span class="s1">&#39;ADMIN EMPRESAS (D)&#39;</span>
      <span class="k">elif</span> <span class="n">plan</span> <span class="o">==</span> <span class="s1">&#39;ADMINISTRACION DE SISTEMAS INFORMATICOS&#39;</span><span class="p">:</span>
          <span class="n">plan</span> <span class="o">=</span> <span class="s1">&#39;ADMIN SISINFO&#39;</span>
      <span class="k">elif</span> <span class="n">plan</span> <span class="o">==</span> <span class="s1">&#39;GESTION CULTURAL Y COMUNICATIVA&#39;</span><span class="p">:</span>
          <span class="n">plan</span> <span class="o">=</span> <span class="s1">&#39;GEST CULT&#39;</span>
      <span class="c1"># Matriculados:</span>
      <span class="n">df_con_tutor</span> <span class="o">=</span> <span class="n">df_con_tutor</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
      <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">df_con_tutor</span><span class="p">,</span> <span class="n">plan</span> <span class="o">+</span> <span class="s1">&#39; CT&#39;</span><span class="p">)</span> <span class="p">)</span>
      
      <span class="n">df_concat_sin_tutor</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_sin_tutor</span><span class="p">,</span> <span class="n">df_matriculados_3</span><span class="p">])</span>
      <span class="n">df_concat_sin_tutor</span> <span class="o">=</span> <span class="n">df_concat_sin_tutor</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
      <span class="n">df_concat_sin_tutor</span><span class="p">[</span><span class="s2">&quot;COMPLETOS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_concat_sin_tutor</span><span class="p">[</span><span class="s2">&quot;NOMBRES&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">df_concat_sin_tutor</span><span class="p">[</span><span class="s2">&quot;APELLIDOS&quot;</span><span class="p">]</span>
      <span class="n">df_arq_st</span> <span class="o">=</span> <span class="n">df_concat_sin_tutor</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;COMPLETOS&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
      <span class="n">df_arq_st</span> <span class="o">=</span> <span class="n">df_arq_st</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;COMPLETOS&quot;</span><span class="p">])</span>
      <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">df_con_tutor</span><span class="p">,</span> <span class="n">plan</span> <span class="o">+</span> <span class="s1">&#39; CT&#39;</span><span class="p">)</span> <span class="p">)</span>
      <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">df_arq_st</span> <span class="p">,</span> <span class="n">plan</span> <span class="o">+</span> <span class="s1">&#39; ST&#39;</span><span class="p">)</span> <span class="p">)</span>
      <span class="n">df_con_tutor</span><span class="p">[</span><span class="s2">&quot;PLAN_TUTOR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plan</span> <span class="o">+</span> <span class="s1">&#39; CT&#39;</span>
      <span class="n">df_arq_st</span><span class="p">[</span><span class="s2">&quot;PLAN_TUTOR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plan</span> <span class="o">+</span> <span class="s1">&#39; ST&#39;</span>
      <span class="n">todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_con_tutor</span><span class="p">)</span>
      <span class="n">todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_arq_st</span><span class="p">)</span>
    <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">todo</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_df</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">df_list</span><span class="p">,</span> <span class="n">new_df</span></div></div>

<span class="c1"># ============================================================================</span>
<span class="c1"># FUNCIONES AUXILIARES:</span>
<span class="c1"># ============================================================================</span>
<div class="viewcode-block" id="DNI_2_TotCred"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.DNI_2_TotCred">[docs]</a><span class="k">def</span> <span class="nf">DNI_2_TotCred</span><span class="p">(</span><span class="n">DNI</span><span class="o">=</span><span class="mi">555</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="c1"># Cedula:</span>
    <span class="n">informe</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">DNI</span><span class="p">]</span>
     <span class="c1"># Creditos:</span>
    <span class="n">cred</span> <span class="o">=</span> <span class="n">informe</span><span class="p">[</span><span class="s1">&#39;CREDITOS_ASIGNATURA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">DNI</span> <span class="o">==</span> <span class="s1">&#39;1080040060&#39;</span><span class="p">:</span>
      <span class="n">y</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cred</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cred</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cred</span><span class="p">)</span> <span class="c1"># Suma de creditos.</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># Se encontro DNI pero por alguna razon no tiene creditos.</span>
  <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No se encuentra col: &#39;</span> <span class="o">+</span> <span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">2</span> <span class="c1"># Sino se encuentra la col. DOCUMENTOS return -&gt; -2</span></div>
<div class="viewcode-block" id="DNI_2_Feature"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.DNI_2_Feature">[docs]</a><span class="k">def</span> <span class="nf">DNI_2_Feature</span><span class="p">(</span><span class="n">DNI</span><span class="o">=</span><span class="mi">555</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()):</span>
  <span class="c1"># Caracteristicas tipo texto:</span>
  <span class="n">string_1_feat</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SEXO&#39;</span><span class="p">,</span> <span class="s1">&#39;DEPARTAMENTO_NACIMIENTO&#39;</span><span class="p">,</span><span class="s1">&#39;DEPARTAMENTO_PROCEDENCIA&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;TIPO_NIVEL&#39;</span><span class="p">,</span><span class="s1">&#39;CONVOCATORIA&#39;</span><span class="p">,</span><span class="s1">&#39;APERTURA&#39;</span><span class="p">]</span>
  <span class="c1"># Caracteristicas tipo numero:</span>
  <span class="n">num_1_feat</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AVANCE_CARRERA&#39;</span><span class="p">]</span>

  <span class="c1"># COD_PLAN FALTA -&gt; SALE UNA LISTA y hay que ver si una sola persona tiene un solo COD de plan?</span>
  <span class="c1"># FALTA PLAN -&gt; UNA PERSONA PUEDE PERTENECER A UN PLAN O A VARIOS AL MISMO TIEMPO?</span>

  <span class="c1"># Cedula:</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">df_buscado</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">DNI</span><span class="p">]</span> <span class="c1"># Empty DataFrame -&gt; No se encontro documento.</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c1"># Salida default:</span>
      <span class="n">salida</span> <span class="o">=</span> <span class="n">df_buscado</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="c1"># -&gt; salida = []</span>
      <span class="c1"># Busqueda texto:</span>
      <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">string_1_feat</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">salida</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">salida</span> <span class="o">=</span> <span class="s1">&#39;INDEFINIDO&#39;</span> <span class="c1"># No se encontró en df</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">salida</span> <span class="o">=</span> <span class="n">salida</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># string</span>
        <span class="k">return</span> <span class="n">salida</span>
      <span class="c1"># Busqueda numerica:</span>
      <span class="k">elif</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">num_1_feat</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">salida</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">salida</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span> <span class="c1"># No se encontró en df</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">salida</span> <span class="o">=</span> <span class="n">salida</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Numero</span>
        <span class="k">return</span> <span class="n">salida</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">salida</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No se encuentra col: &#39;</span> <span class="o">+</span> <span class="n">feature</span><span class="p">)</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">2</span>
  <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No se encuentra col: &#39;</span> <span class="o">+</span> <span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">2</span> <span class="c1"># Sino se encuentra la col. DOCUMENTOS return -&gt; -2</span></div>
<span class="n">ALLOWED_EXTENSIONS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xlsx&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;txt&#39;</span><span class="p">,</span> <span class="s1">&#39;csv&#39;</span><span class="p">}</span>
<div class="viewcode-block" id="allowed_file"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.allowed_file">[docs]</a><span class="k">def</span> <span class="nf">allowed_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> \
           <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ALLOWED_EXTENSIONS</span></div>
<div class="viewcode-block" id="files_in_data"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.files_in_data">[docs]</a><span class="k">def</span> <span class="nf">files_in_data</span><span class="p">(</span><span class="n">path_servicio</span><span class="p">):</span>
    <span class="c1"># folder path</span>
    <span class="n">dir_path</span> <span class="o">=</span> <span class="n">path_servicio</span>

    <span class="c1"># list to store files</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Iterate directory</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
        <span class="c1"># check if current path is a file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">path</span><span class="p">)):</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>
<div class="viewcode-block" id="valid_asignature"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.valid_asignature">[docs]</a><span class="k">def</span> <span class="nf">valid_asignature</span><span class="p">(</span><span class="n">asg</span><span class="p">,</span> <span class="n">posibilities</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">asg</span> <span class="ow">in</span> <span class="n">posibilities</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>
<span class="c1"># General render informe</span>
<div class="viewcode-block" id="render_informe"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.render_informe">[docs]</a><span class="k">def</span> <span class="nf">render_informe</span><span class="p">(</span><span class="n">upload_folder</span><span class="p">,</span><span class="n">sessions</span><span class="p">):</span>
    <span class="n">path_servicio_upload</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upload_folder</span><span class="p">,</span><span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span><span class="s1">&#39;subidos&#39;</span><span class="p">)</span>
    <span class="n">path_servicio_download</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upload_folder</span><span class="p">,</span><span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span><span class="s1">&#39;generados&#39;</span><span class="p">)</span>
    <span class="c1"># lista de archivos:</span>
    <span class="n">files_upload</span> <span class="o">=</span> <span class="n">files_in_data</span><span class="p">(</span><span class="n">path_servicio_upload</span><span class="p">)</span>
    <span class="n">files_download</span> <span class="o">=</span> <span class="n">files_in_data</span><span class="p">(</span><span class="n">path_servicio_download</span><span class="p">)</span>
    <span class="c1"># mensaje:</span>
    <span class="c1"># Upload menssaje:</span>
    <span class="n">list_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">elm1</span> <span class="ow">in</span> <span class="n">files_upload</span> <span class="k">for</span> <span class="n">elm1</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;required_files&#39;</span><span class="p">]]</span>
    <span class="n">tf_upload</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">list_check</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tf_upload</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">Mensaje_Reporte</span> <span class="o">=</span> <span class="s1">&#39;Tienes todos los archivos necesarios.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Mensaje_Reporte</span> <span class="o">=</span> <span class="s1">&#39;No tienes en carpeta los archivos necesarios.&#39;</span>
    <span class="c1"># Donwlod mensaje:</span>
    <span class="n">list_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">elm1</span> <span class="ow">in</span> <span class="n">files_download</span> <span class="k">for</span> <span class="n">elm1</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;download_file&#39;</span><span class="p">]]</span>
    <span class="n">tf_upload</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">list_check</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tf_upload</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">Mensaje_Descargar</span> <span class="o">=</span> <span class="s1">&#39;Tienes todos los archivos necesarios.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Mensaje_Descargar</span> <span class="o">=</span> <span class="s1">&#39;No tienes en carpeta los archivos necesarios.&#39;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span> <span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;path_template&#39;</span><span class="p">],</span>
                            <span class="n">servicio</span><span class="o">=</span><span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;servicio&#39;</span><span class="p">],</span>
                            <span class="n">Mensaje_Reporte</span> <span class="o">=</span> <span class="n">Mensaje_Reporte</span><span class="p">,</span>
                            <span class="n">Mensaje_Descargar</span> <span class="o">=</span> <span class="n">Mensaje_Descargar</span><span class="p">,</span>
                            <span class="n">Mensaje_Actualizacion</span> <span class="o">=</span> <span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;msj_actualizacion&#39;</span><span class="p">],</span>
                            <span class="n">file</span> <span class="o">=</span> <span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">],</span>
                            <span class="n">Mensaje_help_1</span> <span class="o">=</span>  <span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;msjhelp1&#39;</span><span class="p">],</span>
                            <span class="n">Mensaje_help_2</span> <span class="o">=</span>  <span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;msjhelp2&#39;</span><span class="p">],</span>
                            <span class="n">Mensaje_help_3</span> <span class="o">=</span>  <span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;msjhelp3&#39;</span><span class="p">],</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                            <span class="n">link</span> <span class="o">=</span> <span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="normalizacion_col"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.normalizacion_col">[docs]</a><span class="k">def</span> <span class="nf">normalizacion_col</span><span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">unidecode</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">df</span></div>


<span class="c1"># =========================================================================</span>

<span class="c1"># ======================================== UNAL EN LA REGION</span>
<span class="c1"># ======================================================================</span>

<span class="kn">from</span> <span class="nn">shapely.ops</span> <span class="kn">import</span> <span class="n">unary_union</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>

<div class="viewcode-block" id="unir_regiones"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.unir_regiones">[docs]</a><span class="k">def</span> <span class="nf">unir_regiones</span><span class="p">(</span><span class="n">gdf_municipios</span><span class="p">,</span> <span class="n">df_sub_reg</span><span class="p">,</span><span class="n">df</span><span class="p">,</span> <span class="n">departamento_name</span><span class="p">,</span> <span class="n">tf_save</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">path_to_save</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gdf_mun</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;[Su descripcion.]2</span>

<span class="sd">    :param gdf_municipios: objeto geopandas con municipios, defaults to &lt;Sin valor por defecto&gt;</span>
<span class="sd">    :type gdf_municipios: objeto geopandas</span>

<span class="sd">    :param df_sub_reg: dataframe pandas con info de subregiones, defaults to &lt;Sin valor por defecto&gt;</span>
<span class="sd">    :type df_sub_reg: DataFramePandas</span>

<span class="sd">    :param df: dataframe con info de municipios y sus coordenadas, defaults to &lt;Sin valor por defecto&gt;</span>
<span class="sd">    :type df:objeto geopandas</span>

<span class="sd">    :param departamento_name: nombre del departamento objetivo, defaults to &lt;Sin valor por defecto&gt;</span>
<span class="sd">    :type departamento_name: str</span>

<span class="sd">    :param tf_save: opcion para guardar el gdf_subregiones, defaults to False</span>
<span class="sd">    :type tf_save: boolean </span>

<span class="sd">    :param path_to_save: path para guardar gdf_subregiones, defaults to None</span>
<span class="sd">    :type path_to_save: str</span>

<span class="sd">    :param gdf_mun: opcion para obtener  los poligonos de los municipios de un departamento</span>
<span class="sd">    :type gdf_mun: boolean</span>

<span class="sd">    :return: gdf_subregiones</span>
<span class="sd">    :rtype: objeto geopandas</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># ====== PASOS REQUERIDOS ======= #</span>
    <span class="c1"># paso 1. filtrar gdf_municipios por departamento con departamento_name</span>
    <span class="c1"># paso 2. obtener municipios del filtrado anterior.</span>
    <span class="c1"># paso 3. por cada una de las sub regiones df_sub_reg obtener de gdf_municipio_filtrado las geometrias...</span>
    <span class="c1"># paso 4. unir los municipios y ponerle nombre de sub reguion de df_sub_reg y guardarlo en gdf_subregiones</span>
    <span class="c1"># paso 5. si tf_save = True...</span>
    <span class="c1"># paso 6. guardar el gdf_subregiones en la direccion path_to_save</span>

    <span class="c1">#------------BORRAMOS LOS ELEMENTOS NAN DE EL ARCHIVO GEOJSON---------------------#</span>
    <span class="n">gdf_municipios</span><span class="o">=</span><span class="n">gdf_municipios</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dpt&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
    <span class="c1">#------------FILTRAMOS EL ARCHIVO POR EL DEPARTAMENTO DE INTERES-------------------#</span>
    <span class="n">nom_mun</span><span class="o">=</span><span class="n">gdf_municipios</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdf_municipios</span><span class="p">[</span><span class="s1">&#39;dpt&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">departamento_name</span><span class="p">]</span>
    <span class="n">nom_mun</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">nom_mun</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span>
    <span class="c1">#-----------------------JSON CON LAS COORDENADAS ADECUADAS-----------------#</span>
    <span class="n">df_mu</span><span class="o">=</span><span class="n">df</span>
    <span class="n">gdf_municipios</span><span class="o">=</span><span class="n">gdf_municipios</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">df_mu</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_mu</span><span class="p">)</span>
    <span class="n">df_mu</span><span class="p">[</span><span class="s1">&#39;MPIO_CNMBR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_mu</span><span class="p">[</span><span class="s1">&#39;MPIO_CNMBR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFKD&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="c1">#--------------------------LEEMOS EL EXCEL----------------------------------------#</span>
    <span class="n">df_sub</span><span class="o">=</span><span class="n">df_sub_reg</span>
    <span class="n">df_sub</span><span class="p">[</span><span class="s1">&#39;MUNICIPIO&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_sub</span><span class="p">[</span><span class="s1">&#39;MUNICIPIO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span>
    <span class="c1">#----------------------------------FILTRAMOS EL DATAFRAME DE LAS SUBREGIONES DEPENDIENDO DEL DEPARTAMENTO -------------------------------------------#</span>
    <span class="n">dep</span><span class="o">=</span><span class="n">df_sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_sub</span><span class="p">[</span><span class="s1">&#39;DPT&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">departamento_name</span><span class="p">]</span>
    <span class="c1">#---------------------------------AGREGAMOS LAS SUBREGIONES DEPENDIENDO DE LOS MUNICIPIOS AL DF MUNICIPIOS--------------------------------------------#</span>
    <span class="n">nom_mun</span><span class="p">[</span><span class="s1">&#39;subregiones&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nom_mun</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;MUNICIPIO&#39;</span><span class="p">)[</span><span class="s1">&#39;SUBREGIONES&#39;</span><span class="p">])</span>
    <span class="n">nom_mun</span><span class="p">[</span><span class="s1">&#39;DPTO_CCDGO&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">nom_mun</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;MUNICIPIO&#39;</span><span class="p">)[</span><span class="s1">&#39;DPTO_CCDGO&#39;</span><span class="p">])</span>
    <span class="n">idx_no</span><span class="o">=</span><span class="n">nom_mun</span><span class="p">[</span><span class="s1">&#39;DPTO_CCDGO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">df_mu</span><span class="o">=</span><span class="n">df_mu</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_mu</span><span class="p">[</span><span class="s1">&#39;DPTO_CCDGO&#39;</span><span class="p">]</span><span class="o">==</span><span class="nb">str</span><span class="p">(</span><span class="n">idx_no</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="n">nom_mun</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">nom_mun</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">df_mu</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;MPIO_CNMBR&#39;</span><span class="p">)[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">gdf_mun</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nom_mun</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
    <span class="c1">#----------------------------------------UNIMOS LOS POLIGONOS DE LOS MUNICIPIOS DEPENDIENDO DE LA SUBREGION------------------------------------------#</span>

    <span class="c1">#CREAMOS UN DICCIONARIO PARA GUARDAR LOS POLIGONOS Y EL NOMBRE DE LOS MUNICIPIOS#</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subreg_nom</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">subreg_pol</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nom_mun</span><span class="o">.</span><span class="n">subregiones</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">subregion_pol</span><span class="o">=</span><span class="n">nom_mun</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nom_mun</span><span class="p">[</span><span class="s1">&#39;subregiones&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">i</span><span class="p">]</span>
            <span class="n">subreg_nom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">subreg_pol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">unary_union</span><span class="p">(</span><span class="n">subregion_pol</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">df_subreg</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;subregion&#39;</span><span class="p">:</span><span class="n">subreg_nom</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span><span class="n">subreg_pol</span><span class="p">}</span>
        <span class="n">df_subreg</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_subreg</span><span class="p">)</span>
        <span class="c1">#----------------------------------------CONVERTIMOS EL DF DE PANDAS A GEOPANDAS----------------------------------------#</span>
        <span class="n">geo_subreg</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">df_subreg</span><span class="p">[[</span><span class="s1">&#39;subregion&#39;</span><span class="p">]],</span> <span class="n">geometry</span><span class="o">=</span><span class="n">df_subreg</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="c1">#---------------------------------------EXPORTAMOS EL GEO DF EN UN GEOJSON------------------------------------------------#</span>
        <span class="k">if</span> <span class="n">tf_save</span><span class="p">:</span>
            <span class="n">path_to_save</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span><span class="sa">F</span><span class="s2">&quot;subreg_</span><span class="si">{</span><span class="n">departamento_name</span><span class="si">}</span><span class="s2">.geojson&quot;</span><span class="p">)</span>
            <span class="n">geo_subreg</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;GeoJSON&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">geo_subreg</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span></div>
    
<span class="c1"># FUNCION PARA LEER EL JSON FILE</span>

<div class="viewcode-block" id="read_json_file"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.read_json_file">[docs]</a><span class="k">def</span> <span class="nf">read_json_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>

    
<span class="c1"># Funcion para hacer match:</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">path_planes = os.path.join(&#39;src&#39;,&#39;data&#39;,&#39;Planes.xlsx&#39;)</span>
<span class="sd">df_planes = pd.read_excel(path_planes)</span>
<span class="sd"># crear df nueva:</span>
<span class="sd">df_planes[&#39;NOMID1&#39;] = df_planes[&#39;NOMID1&#39;].str.upper()</span>
<span class="sd">df_planes[&#39;NOMID1&#39;] = df_planes[&#39;NOMID1&#39;].apply(unidecode)</span>
<span class="sd">df_nueva = df_planes[[&#39;FAC&#39;, &#39;NOMID1&#39;]].copy()</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Convertir sintaxis</span>
<span class="c1"># Lista de palabras a dejar en minúsculas</span>
<span class="c1"># Función para capitalizar las primeras letras y dejar palabras específicas en minúsculas</span>
<div class="viewcode-block" id="capitalize_text"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.capitalize_text">[docs]</a><span class="k">def</span> <span class="nf">capitalize_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">palabras_a_min</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="s1">&#39;de&#39;</span><span class="p">,</span> <span class="s1">&#39;la&#39;</span><span class="p">]</span>
    <span class="k">if</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
      <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
      <span class="n">capitalized_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">palabras_a_min</span> <span class="k">else</span> <span class="n">word</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span>
      <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">capitalized_words</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">text</span></div>



<span class="c1"># # Función para encontrar el string más cercano</span>
<div class="viewcode-block" id="encontrar_mas_cercano"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.encontrar_mas_cercano">[docs]</a><span class="k">def</span> <span class="nf">encontrar_mas_cercano</span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="n">case_match</span><span class="p">):</span>
  <span class="c1"># facultades</span>
  <span class="k">if</span> <span class="n">case_match</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">lista_strings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FACULTAD DE INGENIERIA Y ARQUITECTURA&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;FACULTAD DE ADMINISTRACION&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;FACULTAD DE CIENCIAS EXACTAS Y NATURALES&#39;</span><span class="p">]</span>
    
    <span class="k">try</span><span class="p">:</span>
      <span class="n">matches</span> <span class="o">=</span> <span class="n">get_close_matches</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">lista_strings</span><span class="p">)</span>
      <span class="c1">#matches = convertir_palabras_iniciales_mayuscula(matches)</span>
      <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Devuelve el primer string más cercano</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">string</span>  <span class="c1"># Si no hay coincidencias, conserva el valor original</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">return</span> <span class="s1">&#39;&#39;</span>
  <span class="c1"># programas</span>
  <span class="k">elif</span> <span class="n">case_match</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">lista_strings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;INGENIERIA CIVIL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;INGENIERIA ELECTRICA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;INGENIERIA QUIMICA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;INGENIERIA INDUSTRIAL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ARQUITECTURA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ADMINISTRACION DE EMPRESAS (D)&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ADMINISTRACION DE EMPRESAS (N)&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;INGENIERIA ELECTRONICA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ADMINISTRACION DE SISTEMAS INFORMATICOS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;INGENIERIA FISICA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;CONSTRUCCION&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MATEMATICAS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GESTION CULTURAL Y COMUNICATIVA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;CIENCIAS DE LA COMPUTACION&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ADMINISTRACION DE SISTEMAS INFORMATICOS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN DIRECCION DE PRODUCCION Y OPERACIONES&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN GESTION DE REDES DE DATOS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN INGENIERIA AMBIENTAL - AREA SANITARIA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN INGENIERIA FINANCIERA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN VIAS Y TRANSPORTE&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN AUTOMATIZACION INDUSTRIAL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN DESARROLLO DE MARKETING CORPORATIVO&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN FINANZAS CORPORATIVAS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN GESTION CULTURAL, ENFASIS EN PLANEACION Y POLITICAS CULT&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN AUDITORIA DE SISTEMAS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN INGENIERIA HIDRAULICA Y AMBIENTAL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN GERENCIA ESTRATEGICA DE PROYECTOS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN ESTRUCTURAS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN ALTA GERENCIA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN INGENIERIA ELECTRICA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN ESTADISTICA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN ACTUARIA Y FINANZAS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN GEOTECNIA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN BIONEGOCIOS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN LOGISTICA Y CADENAS DE ABASTECIMIENTO&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN BIOINGENIERIA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN NANOTECNOLOGIA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN ADMINISTRACION&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN CIENCIAS - MATEMATICA APLICADA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN CIENCIAS - FISICA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN HABITAT&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN INGENIERIA - INGENIERIA QUIMICA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN MEDIO AMBIENTE Y DESARROLLO&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN INGENIERIA - AUTOMATIZACION INDUSTRIAL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN INGENIERIA - INGENIERIA INDUSTRIAL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN ENSENANZA DE LAS CIENCIAS EXACTAS Y NATURALES&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN INGENIERIA - INGENIERIA ELECTRICA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN INGENIERIA - INGENIERIA AMBIENTAL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN INGENIERIA - INFRAESTRUCTURA Y SISTEMAS DE TRANSPORTE&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN ADMINISTRACION DE SISTEMAS INFORMATICOS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN INGENIERIA - ESTRUCTURAS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN INGENIERIA - RECURSOS HIDRAULICOS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN GESTION CULTURAL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN ARQUITECTURA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;DOCTORADO EN INGENIERIA AUTOMATICA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;DOCTORADO EN INGENIERIA - INDUSTRIA Y ORGANIZACIONES&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;DOCTORADO EN INGENIERIA - INGENIERIA QUIMICA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;DOCTORADO EN INGENIERIA - INGENIERIA CIVIL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;DOCTORADO EN ADMINISTRACION&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;DOCTORADO EN CIENCIAS - MATEMATICAS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;DOCTORADO EN CIENCIAS - FISICA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;DOCTORADO EN ESTUDIOS AMBIENTALES&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN AUTOMATIZACION INDUSTRIAL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN ADMINISTRACION&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN INGENIERIA AUTOMATIZACION INDUSTRIAL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN INGENIERIA AUTOMATIZACION INDUSTRIAL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN ADMINISTRACION&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN GESTION DE REDES DE DATOS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN CIENCIAS - MATEMATICA APLICADA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN ADMINISTRACION&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN ADMINISTRACION&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN VIAS Y TRANSPORTE&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN GERENCIA ESTRATEGICA DE PROYECTOS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN GERENCIA ESTRATEGICA DE PROYECTOS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;MAESTRIA EN INGENIERIA - INGENIERIA ELECTRICA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION ALTA GERENCIA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN VIAS Y TRANSPORTE&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN INGENIERIA HIDRAULICA Y AMBIENTAL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN ESTRUCTURAS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN FINANZAS CORPORATIVAS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ESPECIALIZACION EN INGENIERIA HIDRAULICA Y AMBIENTAL&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">matches</span> <span class="o">=</span> <span class="n">get_close_matches</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">lista_strings</span><span class="p">)</span>
      <span class="c1">#matches = convertir_palabras_iniciales_mayuscula(matches)</span>
      <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Devuelve el primer string más cercano</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">string</span>  <span class="c1"># Si no hay coincidencias, conserva el valor original</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>
    
<div class="viewcode-block" id="fill_empty_spaces"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.fill_empty_spaces">[docs]</a><span class="k">def</span> <span class="nf">fill_empty_spaces</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns_to_exclude</span> <span class="o">=</span> <span class="p">[</span>
   <span class="s2">&quot;G1&quot;</span><span class="p">,</span> <span class="s2">&quot;G2&quot;</span><span class="p">,</span> <span class="s2">&quot;G3&quot;</span><span class="p">,</span> <span class="s2">&quot;G4&quot;</span><span class="p">,</span> <span class="s2">&quot;G5&quot;</span><span class="p">,</span> <span class="s2">&quot;G6&quot;</span><span class="p">,</span> <span class="s2">&quot;G7&quot;</span><span class="p">,</span> <span class="s2">&quot;PBM&quot;</span><span class="p">,</span> <span class="s2">&quot;PROM_ACADEMICO_ACTUAL&quot;</span><span class="p">,</span>
   <span class="s2">&quot;PAPA_PERIODO&quot;</span><span class="p">,</span> <span class="s2">&quot;AVANCE_CARRERA&quot;</span><span class="p">,</span><span class="s2">&quot;FECHA&quot;</span><span class="p">]):</span>
    <span class="n">filled_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">filled_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns_to_exclude</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
              <span class="n">filled_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">filled_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Sin Informacion&quot;</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
               <span class="k">pass</span>
    
    <span class="k">return</span> <span class="n">filled_df</span></div>



<span class="c1"># =================== NUEVO REQUERIMIENTO PSL ================================</span>

<div class="viewcode-block" id="asistenciaOriginal_to_estandar_AV"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.asistenciaOriginal_to_estandar_AV">[docs]</a><span class="k">def</span> <span class="nf">asistenciaOriginal_to_estandar_AV</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">rangos</span><span class="p">):</span>
  <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
  <span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">file</span><span class="p">))]</span>
  <span class="n">resultado</span> <span class="o">=</span> <span class="n">extraer_numeros_letras</span><span class="p">(</span><span class="n">rangos</span><span class="p">)</span>
  <span class="n">df_salida</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file_names</span><span class="p">):</span>
      <span class="n">name_psl</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span><span class="n">file</span><span class="p">)</span>
      <span class="n">tupla</span><span class="p">,</span> <span class="n">letras</span> <span class="o">=</span> <span class="n">resultado</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">df_i</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">name_psl</span><span class="p">,</span> <span class="n">sheet_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">skiprows</span> <span class="o">=</span> <span class="n">tupla</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nrows</span><span class="o">=</span><span class="n">tupla</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="n">usecols</span><span class="o">=</span> <span class="n">letras</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File name = </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> con rangos </span><span class="si">{</span><span class="n">tupla</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">tupla</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="n">resultado_t</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Asistencia_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span>
      <span class="n">df_i</span><span class="p">[</span><span class="s2">&quot;SUB_SERVICIO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resultado_t</span>
      <span class="n">df_new</span> <span class="o">=</span> <span class="n">concatenate_information_by_date</span><span class="p">(</span><span class="n">df_i</span><span class="p">)</span>
      <span class="c1"># BORRAR</span>
      <span class="n">columns_news</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_new</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
      <span class="n">df_new</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns_news</span>
      <span class="n">df_salida</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_salida</span><span class="p">,</span> <span class="n">df_new</span><span class="p">])</span>
  <span class="c1"># strip colums:</span>
  <span class="n">columns_news</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_salida</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
  <span class="n">df_salida</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns_news</span>
  <span class="c1"># cambiar oden:2</span>
  <span class="n">df_salida_v2</span> <span class="o">=</span> <span class="n">df_salida</span><span class="p">[[</span><span class="s2">&quot;FECHA&quot;</span><span class="p">,</span><span class="s2">&quot;DOCUMENTO&quot;</span><span class="p">,</span><span class="s2">&quot;CORREO&quot;</span><span class="p">,</span><span class="s2">&quot;NOMBRES Y APELLIDOS&quot;</span><span class="p">,</span><span class="s2">&quot;SUB_SERVICIO&quot;</span><span class="p">,</span> <span class="s2">&quot;PROGRAMA&quot;</span><span class="p">,</span><span class="s2">&quot;FACULTAD&quot;</span><span class="p">]]</span>
  <span class="c1"># Borrar cuando se quite encuesta:</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span>
    <span class="n">df_salida_v2</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;G</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="c1"># agregar </span>
  <span class="n">df_salida_v2</span><span class="p">[</span><span class="s2">&quot;CEDULA-RI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_salida</span><span class="p">[</span><span class="s2">&quot;PROFESIONAL PSL&quot;</span><span class="p">]</span>
  <span class="n">df_salida_v2</span><span class="p">[</span><span class="s2">&quot;PERIODO-AT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_salida</span><span class="p">[</span><span class="s2">&quot;PERIODO DE ATENCIÓN&quot;</span><span class="p">]</span>
  <span class="n">df_salida_v2</span> <span class="o">=</span> <span class="n">df_salida_v2</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;FACULTAD&quot;</span><span class="p">:</span><span class="s2">&quot;MI-FACULTAD&quot;</span><span class="p">})</span>
  <span class="n">df_salida_v2</span> <span class="o">=</span> <span class="n">df_salida_v2</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;SUB_SERVICIO&quot;</span><span class="p">:</span><span class="s2">&quot;SUBSERVICIO&quot;</span><span class="p">})</span>
  <span class="n">df_salida_v2</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">df_salida_v2</span></div>
    

<div class="viewcode-block" id="asistenciaOriginal_to_estandar_TIC"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.asistenciaOriginal_to_estandar_TIC">[docs]</a><span class="k">def</span> <span class="nf">asistenciaOriginal_to_estandar_TIC</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">rangos</span><span class="p">):</span>
  <span class="n">excel_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
  <span class="n">resultado</span> <span class="o">=</span> <span class="n">extraer_numeros_letras</span><span class="p">(</span><span class="n">rangos</span><span class="p">)</span>
  <span class="n">df_salida_2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">resultados</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">resultado</span><span class="p">):</span>
      <span class="n">tupla</span><span class="p">,</span> <span class="n">letras</span> <span class="o">=</span> <span class="n">resultados</span>
      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Tupla de números: </span><span class="si">{</span><span class="n">tupla</span><span class="si">}</span><span class="s1">, String de letras: </span><span class="si">{</span><span class="n">letras</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
      <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">excel_file</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
      <span class="n">key_i</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="c1">#df_i = excel_file[key_i]</span>
      <span class="n">df_new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">key_i</span><span class="p">,</span> <span class="n">skiprows</span> <span class="o">=</span> <span class="n">tupla</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nrows</span><span class="o">=</span><span class="n">tupla</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">usecols</span><span class="o">=</span><span class="n">letras</span><span class="p">)</span>
      <span class="n">df_new</span> <span class="o">=</span> <span class="n">concatenate_information_by_date</span><span class="p">(</span><span class="n">df_new</span><span class="p">)</span>
      <span class="n">df_new</span><span class="p">[</span><span class="s2">&quot;SUB_SERVICIO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_i</span>
      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hoja = </span><span class="si">{</span><span class="n">key_i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Asistencias = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_new</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="n">df_salida_2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_salida_2</span><span class="p">,</span> <span class="n">df_new</span><span class="p">])</span>
  <span class="c1"># strip colums:</span>
  
  <span class="n">columns_news</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_salida_2</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
  <span class="n">df_salida_2</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns_news</span>
  <span class="c1"># cambiar oden:2</span>
  <span class="n">df_salida_v2</span> <span class="o">=</span> <span class="n">df_salida_2</span><span class="p">[[</span><span class="s2">&quot;FECHA&quot;</span><span class="p">,</span><span class="s2">&quot;NOMBRES Y APELLIDOS&quot;</span><span class="p">,</span><span class="s2">&quot;CORREO&quot;</span><span class="p">,</span><span class="s2">&quot;DOCUMENTO&quot;</span><span class="p">,</span> <span class="s2">&quot;PROGRAMA&quot;</span><span class="p">,</span><span class="s2">&quot;ASIGNATURA&quot;</span><span class="p">,</span><span class="s2">&quot;NOTA FINAL&quot;</span><span class="p">]]</span>
  <span class="n">df_salida_v2</span><span class="p">[</span><span class="s2">&quot;PRODUCTO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="c1"># Borrar cuando se quite encuesta:</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">df_salida_v2</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;G</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="c1"># agregar</span>
  <span class="n">df_salida_v2</span><span class="p">[</span><span class="s2">&quot;NOMBRE-RE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_salida_2</span><span class="p">[</span><span class="s2">&quot;DOCENTE TITULAR&quot;</span><span class="p">]</span>
  <span class="n">df_salida_v2</span><span class="p">[</span><span class="s2">&quot;CODIGO ASIGNATURA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="n">df_salida_v2</span><span class="p">[</span><span class="s2">&quot;CORREO-RE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="n">df_salida_v2</span><span class="p">[</span><span class="s2">&quot;CEDULA-RI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_salida_2</span><span class="p">[</span><span class="s2">&quot;PROFESIONAL PSL&quot;</span><span class="p">]</span>
  <span class="n">df_salida_v2</span><span class="p">[</span><span class="s2">&quot;TIPO-RI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="n">df_salida_v2</span><span class="p">[</span><span class="s2">&quot;PERIODO-AT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_salida_2</span><span class="p">[</span><span class="s2">&quot;PERIODO DE ATENCIÓN&quot;</span><span class="p">]</span>
  <span class="n">df_salida_v2</span> <span class="o">=</span> <span class="n">df_salida_v2</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;NOTA FINAL&quot;</span><span class="p">:</span><span class="s2">&quot;NOTA&quot;</span><span class="p">})</span>
  <span class="n">df_salida_v2</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">df_salida_v2</span> <span class="o">=</span> <span class="n">df_salida_v2</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^(?!Unnamed:).&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==========================================&quot;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">df_salida_v2</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
  <span class="k">return</span> <span class="n">df_salida_v2</span></div>


<div class="viewcode-block" id="extraer_numeros_letras"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.extraer_numeros_letras">[docs]</a><span class="k">def</span> <span class="nf">extraer_numeros_letras</span><span class="p">(</span><span class="n">rangos</span><span class="p">):</span>
    <span class="n">resultados</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rango</span> <span class="ow">in</span> <span class="n">rangos</span><span class="p">:</span>
        <span class="c1"># Utilizamos expresiones regulares para extraer los números y las letras</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([A-Z]+)(\d+):([A-Z]+)(\d+)&#39;</span><span class="p">,</span> <span class="n">rango</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="c1"># Extraemos los grupos de la expresión regular</span>
            <span class="n">letras_inicio</span><span class="p">,</span> <span class="n">numero_inicio</span><span class="p">,</span> <span class="n">letras_fin</span><span class="p">,</span> <span class="n">numero_fin</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="c1"># Convertimos los números a enteros</span>
            <span class="n">numero_inicio</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numero_inicio</span><span class="p">)</span>
            <span class="n">numero_fin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numero_fin</span><span class="p">)</span>
            <span class="c1"># Creamos las tuplas y el string de letras</span>
            <span class="n">tupla_numeros</span> <span class="o">=</span> <span class="p">(</span><span class="n">numero_inicio</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numero_fin</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">string_letras</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">letras_inicio</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">letras_fin</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">resultados</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tupla_numeros</span><span class="p">,</span> <span class="n">string_letras</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">resultados</span></div>


<span class="c1"># Esta funcion recibe df...</span>
<div class="viewcode-block" id="concatenate_information_by_date"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.concatenate_information_by_date">[docs]</a><span class="k">def</span> <span class="nf">concatenate_information_by_date</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="c1"># Primero identificar columnas tipo fecha y columnas &quot;normales&quot;</span>
    <span class="n">columnas_dates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">columnas_otras</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="c1"># utilizando la funcion find_date_datetime identificar si la columna es tipo fecha.</span>
        <span class="n">tf_date</span> <span class="o">=</span> <span class="n">find_date_datetime</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="c1"># identificar si la columna del df es de fecha:</span>
        <span class="k">if</span> <span class="n">tf_date</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">columnas_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">columnas_otras</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cantidad de columnas tipo fecha = </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">columnas_dates</span><span class="p">)</span>
    <span class="c1"># Crear una dataframe para concatenar por hoja.</span>
    <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">columnas_otras</span><span class="p">)</span>
    <span class="c1"># Por cada columna de fecha...</span>
    <span class="k">for</span> <span class="n">col_date</span> <span class="ow">in</span> <span class="n">columnas_dates</span><span class="p">:</span>
        <span class="c1"># Iterar sobre las filas de df</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1"># Identificar la asistencia:</span>
            <span class="n">campo_asistencia</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col_date</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">campo_asistencia</span> <span class="o">=</span> <span class="n">campo_asistencia</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">campo_asistencia</span> <span class="o">=</span> <span class="n">campo_asistencia</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">campo_asistencia</span> <span class="o">=</span> <span class="n">unidecode</span><span class="p">(</span><span class="n">campo_asistencia</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">campo_asistencia</span> <span class="o">==</span> <span class="s1">&#39;SI&#39;</span><span class="p">:</span>
                <span class="c1"># Crear diccionario vacio para concatenar valores por fila:</span>
                <span class="n">dict_to_append</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">col_new_df</span> <span class="ow">in</span> <span class="n">new_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="c1"># como FECHA no esta en los datos originales de debe identificar para ponerla.</span>
                    <span class="k">if</span> <span class="n">col_new_df</span> <span class="o">!=</span> <span class="s1">&#39;FECHA&#39;</span><span class="p">:</span>
                        <span class="n">dict_to_append</span><span class="p">[</span><span class="n">col_new_df</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">col_new_df</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dict_to_append</span><span class="p">[</span><span class="n">col_new_df</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_date</span><span class="p">]</span>
                <span class="c1"># concatenar:</span>
                <span class="n">df_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dict_to_append</span><span class="p">)</span>
                <span class="c1">#new_df = new_df.append(dict_to_append, ignore_index=True)</span>
                <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_row</span><span class="p">,</span> <span class="n">new_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># devolver hoja concatenada:</span>
    <span class="k">return</span> <span class="n">new_df</span></div>

<span class="c1"># Funcion para identificar las fechas en las columnas:</span>
<div class="viewcode-block" id="find_date_regular_expresion"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.find_date_regular_expresion">[docs]</a><span class="k">def</span> <span class="nf">find_date_regular_expresion</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">re_expre</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\b(\d</span><span class="si">{2}</span><span class="s2">)/(\d</span><span class="si">{2}</span><span class="s2">)/(\d</span><span class="si">{4}</span><span class="s2">)\b&quot;</span><span class="p">):</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span> <span class="n">re_expre</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
    <span class="n">fecha</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">fecha</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fecha</span></div>
<div class="viewcode-block" id="find_date_datetime"><a class="viewcode-back" href="../../../reportes.backend.html#reportes.backend.dll_copy.find_date_datetime">[docs]</a><span class="k">def</span> <span class="nf">find_date_datetime</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Carlos Riascos.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>